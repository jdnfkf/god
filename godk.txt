loadstring([[
-- ==============================================
-- 智能全场景防死亡脚本（含观战+生命计数专属逻辑）
-- ==============================================
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local CoreGui = game:GetService("CoreGui")

local GlobalState = {
    IsGodMode = true,
    ToggleKey = Enum.KeyCode.F3,
    DetectedMechanisms = {
        HasRemoteDeath = false,
        HasStateProperty = false,
        HasDestroyDeath = false,
        HasNetworkPacket = false,
        HasSpectateLife = false -- 新增：是否是观战+生命计数机制
    },
    IsCharLoaded = false,
    LastPosition = Vector3.new(0,0,0)
}

-- 工具：显示屏幕提示
local function ShowScreenTip(title, content, duration)
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "SmartAntiDeathTip"
    ScreenGui.Parent = CoreGui
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    local Frame = Instance.new("Frame")
    Frame.Size = UDim2.new(0.8, 0, 0.4, 0)
    Frame.Position = UDim2.new(0.1, 0, 0.5, 0)
    Frame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    Frame.BackgroundTransparency = 0.2
    Frame.BorderSizePixel = 0
    Frame.Parent = ScreenGui

    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 12)
    UICorner.Parent = Frame

    local Title = Instance.new("TextLabel")
    Title.Size = UDim2.new(1, 0, 0.2, 0)
    Title.Position = UDim2.new(0, 0, 0.05, 0)
    Title.BackgroundTransparency = 1
    Title.Text = title
    Title.TextColor3 = Color3.fromRGB(255, 200, 0)
    Title.TextScaled = true
    Title.Font = Enum.Font.GothamBold
    Title.Parent = Frame

    local Content = Instance.new("TextLabel")
    Content.Size = UDim2.new(1, 0, 0.7, 0)
    Content.Position = UDim2.new(0, 0, 0.25, 0)
    Content.BackgroundTransparency = 1
    Content.Text = content
    Content.TextColor3 = Color3.fromRGB(255, 255, 255)
    Content.TextScaled = true
    Content.Font = Enum.Font.Gotham
    Content.TextWrapped = true
    Content.Parent = Frame

    task.wait(duration)
    for i = 1, 20 do
        Frame.BackgroundTransparency += 0.04
        Title.TextTransparency += 0.05
        Content.TextTransparency += 0.05
        task.wait(0.1)
    end
    ScreenGui:Destroy()
end

-- 新增：观战+生命计数专属逻辑
local function SpectateLifeLogic()
    -- 1. 记录位置
    LocalPlayer.CharacterAdded:Connect(function(char)
        local humRoot = char:WaitForChild("HumanoidRootPart", 3)
        if humRoot then
            GlobalState.LastPosition = humRoot.Position
            humRoot:GetPropertyChangedSignal("Position"):Connect(function()
                GlobalState.LastPosition = humRoot.Position
            end)
        end
    end)

    -- 2. 拦截生命计数
    local function InterceptLifeCount()
        local lifeKeywords = {"life", "生命", "count"}
        for _, remote in ipairs(ReplicatedStorage:GetDescendants()) do
            if (remote:IsA("RemoteEvent") or remote:IsA("RemoteFunction")) then
                local name = remote.Name:lower()
                for _, kw in ipairs(lifeKeywords) do
                    if name:find(kw) then
                        if remote:IsA("RemoteEvent") then
                            remote.OnClientEvent:Connect(function(data)
                                if GlobalState.IsGodMode and data and (data.Type == "LifeCount" or data.Type == "生命计数") then
                                    data.Count = 999
                                end
                            end)
                        else
                            remote.OnClientInvoke = function(data)
                                if GlobalState.IsGodMode and data and (data.Type == "LifeCount" or data.Type == "生命计数") then
                                    return 999
                                end
                            end
                        end
                    end
                end
            end
        end
        ReplicatedStorage.DescendantAdded:Connect(function(obj)
            if (obj:IsA("RemoteEvent") or obj:IsA("RemoteFunction")) then
                local name = obj.Name:lower()
                for _, kw in ipairs(lifeKeywords) do
                    if name:find(kw) then
                        if obj:IsA("RemoteEvent") then
                            obj.OnClientEvent:Connect(function(data)
                                if GlobalState.IsGodMode and data and (data.Type == "LifeCount" or data.Type == "生命计数") then
                                    data.Count = 999
                                end
                            end)
                        else
                            obj.OnClientInvoke = function(data)
                                if GlobalState.IsGodMode and data and (data.Type == "LifeCount" or data.Type == "生命计数") then
                                    return 999
                                end
                            end
                        end
                    end
                end
            end
        end)
    end

    -- 3. 突破观战+重生
    RunService.Heartbeat:Connect(function()
        if not GlobalState.IsGodMode then return end
        local isSpectating = false
        for _, gui in ipairs(LocalPlayer.PlayerGui:GetDescendants()) do
            if gui:IsA("TextLabel") and (gui.Text:find("正在观看") or gui.Text:find("观战")) then
                isSpectating = true
                break
            end
        end
        if isSpectating then
            LocalPlayer:LoadCharacter()
            LocalPlayer.CharacterAdded:Wait()
            local newChar = LocalPlayer.Character
            local newHumRoot = newChar:WaitForChild("HumanoidRootPart", 3)
            if newHumRoot and GlobalState.LastPosition ~= Vector3.new(0,0,0) then
                newChar:PivotTo(CFrame.new(GlobalState.LastPosition))
            end
        end
    end)

    -- 4. 锁定生命计数
    pcall(function()
        local PlayerData = LocalPlayer:FindFirstChild("PlayerData")
        if PlayerData then
            local lifeVals = {"LifeCount", "生命计数", "剩余生命"}
            for _, valName in ipairs(lifeVals) do
                local LifeCount = PlayerData:FindFirstChild(valName)
                if LifeCount then
                    LifeCount.Changed:Connect(function()
                        if GlobalState.IsGodMode then
                            LifeCount.Value = 999
                        end
                    end)
                end
            end
        end
    end)
end

-- 阶段1：自动检测游戏机制（新增观战+生命计数检测）
local function DetectGameMechanisms()
    ShowScreenTip("智能检测中", "正在识别游戏死亡机制...", 2)
    repeat task.wait(0.2) until LocalPlayer.Character ~= nil
    GlobalState.IsCharLoaded = true

    -- 检测1：远程指令死亡
    for _, obj in ipairs(ReplicatedStorage:GetDescendants()) do
        if (obj:IsA("RemoteEvent") or obj:IsA("RemoteFunction")) and obj.Name:lower():find("dead") then
            GlobalState.DetectedMechanisms.HasRemoteDeath = true
            break
        end
    end

    -- 检测2：状态属性死亡
    for _, prop in ipairs({"IsDead", "Dead", "State"}) do
        if LocalPlayer:FindFirstChild(prop) then
            GlobalState.DetectedMechanisms.HasStateProperty = true
            break
        end
    end

    -- 检测3：角色销毁死亡
    local testChar = Instance.new("Model")
    testChar.AncestryChanged:Connect(function(_, parent)
        if not parent then GlobalState.DetectedMechanisms.HasDestroyDeath = true end
    end)
    testChar.Parent = Workspace
    testChar.Parent = nil

    -- 检测4：网络包同步
    pcall(function()
        local Network = game:GetService("NetworkClient")
        if Network then GlobalState.DetectedMechanisms.HasNetworkPacket = true end
    end)

    -- 新增检测5：观战+生命计数机制
    local hasSpectateUI = false
    for _, gui in ipairs(LocalPlayer.PlayerGui:GetDescendants()) do
        if gui:IsA("TextLabel") and (gui.Text:find("正在观看") or gui.Text:find("观战")) then
            hasSpectateUI = true
            break
        end
    end
    local hasLifeCount = false
    pcall(function()
        local PlayerData = LocalPlayer:FindFirstChild("PlayerData")
        if PlayerData then
            local lifeVals = {"LifeCount", "生命计数", "剩余生命"}
            for _, valName in ipairs(lifeVals) do
                if PlayerData:FindFirstChild(valName) then
                    hasLifeCount = true
                    break
                end
            end
        end
    end)
    if hasSpectateUI and hasLifeCount then
        GlobalState.DetectedMechanisms.HasSpectateLife = true
    end

    -- 生成检测结果
    local resultContent = "已识别机制：\n"
    resultContent = GlobalState.DetectedMechanisms.HasRemoteDeath and resultContent .. "- 远程指令死亡\n" or resultContent
    resultContent = GlobalState.DetectedMechanisms.HasStateProperty and resultContent .. "- 状态属性死亡\n" or resultContent
    resultContent = GlobalState.DetectedMechanisms.HasDestroyDeath and resultContent .. "- 角色销毁死亡\n" or resultContent
    resultContent = GlobalState.DetectedMechanisms.HasNetworkPacket and resultContent .. "- 网络包同步死亡\n" or resultContent
    resultContent = GlobalState.DetectedMechanisms.HasSpectateLife and resultContent .. "- 观战+生命计数机制" or resultContent
    resultContent = resultContent == "已识别机制：\n" and "已识别机制：\n- 通用基础机制" or resultContent
    ShowScreenTip("检测完成", resultContent, 5)
end

-- 阶段2：启用匹配逻辑（新增观战+生命计数逻辑）
local function EnableMatchedLogic()
    local enabledLogic = "已启用逻辑：\n"

    -- 逻辑1：远程指令拦截
    if GlobalState.DetectedMechanisms.HasRemoteDeath then
        local function CheckRemote(obj)
            if (obj:IsA("RemoteEvent") or obj:IsA("RemoteFunction")) and obj.Name:lower():find("dead") then
                if obj:IsA("RemoteEvent") then
                    obj.OnClientEvent:Connect(function() if GlobalState.IsGodMode then return end end)
                else
                    obj.OnClientInvoke = function() if GlobalState.IsGodMode then return end end
                end
            end
        end
        ReplicatedStorage.DescendantAdded:Connect(CheckRemote)
        for _, obj in ipairs(ReplicatedStorage:GetDescendants()) do CheckRemote(obj) end
        enabledLogic ..= "- 远程指令拦截\n"
    end

    -- 逻辑2：状态属性覆盖
    if GlobalState.DetectedMechanisms.HasStateProperty then
        pcall(function()
            local mt = getrawmetatable(LocalPlayer)
            setreadonly(mt, false)
            local oldIndex = mt.__index
            mt.__index = function(t, k)
                if GlobalState.IsGodMode and k:lower():find("dead") then return false end
                return oldIndex(t, k)
            end
            setreadonly(mt, true)
        end)
        enabledLogic ..= "- 状态属性覆盖\n"
    end

    -- 逻辑3：销毁拦截
    if GlobalState.DetectedMechanisms.HasDestroyDeath then
        LocalPlayer.CharacterAdded:Connect(function(char)
            char.AncestryChanged:Connect(function(_, parent)
                if GlobalState.IsGodMode and not parent then task.spawn(function() LocalPlayer:LoadCharacter() end) end
            end)
        end)
        enabledLogic ..= "- 角色销毁拦截\n"
    end

    -- 逻辑4：网络包拦截
    if GlobalState.DetectedMechanisms.HasNetworkPacket then
        pcall(function()
            local Network = game:GetService("NetworkClient")
            local oldSend = Network.Send
            Network.Send = function(self, packet)
                if GlobalState.IsGodMode and typeof(packet) == "table" and packet.Type:lower():find("state") then
                    packet.Data.IsDead = false
                end
                return oldSend(self, packet)
            end
        end)
        enabledLogic ..= "- 网络包拦截\n"
    end

    -- 新增逻辑5：观战+生命计数专属逻辑
    if GlobalState.DetectedMechanisms.HasSpectateLife then
        SpectateLifeLogic()
        enabledLogic ..= "- 观战突破+无限生命+原地复活\n"
    end

    -- 通用逻辑：满状态维持
    RunService.Heartbeat:Connect(function()
        if not GlobalState.IsGodMode or not GlobalState.IsCharLoaded then return end
        local char = LocalPlayer.Character
        if char then
            local hum = char:FindFirstChild("Humanoid")
            if hum then hum.Health = hum.MaxHealth; hum.BreakJointsOnDeath = false end
        end
    end)
    if not GlobalState.DetectedMechanisms.HasSpectateLife then
        -- 通用复活逻辑（非观战机制用）
        LocalPlayer.CharacterAdded:Connect(function(char)
            local hum = char:WaitForChild("Humanoid", 5)
            if hum then
                hum.Died:Connect(function()
                    if GlobalState.IsGodMode then
                        task.wait(0.05)
                        LocalPlayer:LoadCharacter()
                    end
                end)
            end
        end)
        enabledLogic ..= "- 通用满状态+极速复活"
    end

    enabledLogic = enabledLogic == "已启用逻辑：\n" and "已启用逻辑：\n- 通用满状态+极速复活" or enabledLogic
    ShowScreenTip("逻辑启用完成", enabledLogic, 5)
end

-- 快捷键开关
game:GetService("UserInputService").InputBegan:Connect(function(input)
    if input.KeyCode == GlobalState.ToggleKey then
        GlobalState.IsGodMode = not GlobalState.IsGodMode
        local status = GlobalState.IsGodMode and "✅ 防死亡功能已开启" or "❌ 防死亡功能已关闭"
        ShowScreenTip("功能切换", status, 2)
    end
end)

-- 启动流程
repeat task.wait(0.5) until LocalPlayer.Character ~= nil
GlobalState.IsCharLoaded = true
DetectGameMechanisms()
task.wait(2.5)
EnableMatchedLogic()
ShowScreenTip("脚本启动完成", "按F3切换功能\n自动适配当前游戏机制", 3)
]])()

loadstring([[
-- æ‰‹æœºç«¯é€šç”¨è¶…å¼ºç”Ÿå­˜è„šæœ¬ï¼ˆä¿®å¤å…ƒè¡¨é”™è¯¯ç‰ˆï¼‰
-- ä½œè€…ï¼šé€šç”¨è„šæœ¬é€‚é…
-- ç‰ˆæœ¬ï¼š4.0 å®Œå…¨ä¿®å¤åªè¯»è¡¨é”™è¯¯

-- ==================== å…¨å±€æœåŠ¡åˆå§‹åŒ– ====================
local PlayerService = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local DebrisService = game:GetService("Debris")
local ScriptContext = game:GetService("ScriptContext")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local StarterPlayer = game:GetService("StarterPlayer")
local StarterGui = game:GetService("StarterGui")
local StarterPack = game:GetService("StarterPack")

-- è·å–æœ¬åœ°ç©å®¶
local LocalPlayer = PlayerService.LocalPlayer
if not LocalPlayer then
    repeat wait() until PlayerService.LocalPlayer
    LocalPlayer = PlayerService.LocalPlayer
end

-- ==================== æ ¸å¿ƒé…ç½®å‚æ•° ====================
local CONFIG = {
    -- å›è¡€ç³»ç»Ÿ
    HEAL_MULTIPLIER = 9, -- 9å€è‡ªåŠ¨å›è¡€ï¼ˆæ‚¨è¦æ±‚çš„é€Ÿåº¦ï¼‰
    HEAL_BASE_RATE = 0.015, -- åŸºç¡€å›è¡€ç‡1.5%/ç§’
    EMERGENCY_HEAL_THRESHOLD = 0.35, -- ç´§æ€¥å›è¡€é˜ˆå€¼
    EMERGENCY_HEAL_BOOST = 2.0, -- ç´§æ€¥å›è¡€é¢å¤–å€ç‡
    HEALTH_CAP = math.huge, -- ç”Ÿå‘½å€¼ä¸Šé™
    
    -- é‡ç”Ÿç³»ç»Ÿ
    RESPAWN_DELAY = 0.02, -- é‡ç”Ÿå»¶è¿Ÿ
    RESPAWN_POSITION_OFFSET = Vector3.new(0, 3, 0), -- é‡ç”Ÿä½ç½®åç§»
    RESPAWN_POSITION_MEMORY = 15, -- ä½ç½®è®°å¿†æ•°é‡
    FORCE_RESPAWN_ATTEMPTS = 5, -- å¼ºåˆ¶é‡ç”Ÿå°è¯•æ¬¡æ•°
    
    -- æŠ“å–æ‹¦æˆªç³»ç»Ÿ
    GRAB_DETECTION_RADIUS = 30,
    GRAB_FORCE_THRESHOLD = 8000,
    ANTI_GRAB_PUSH_FORCE = 25,
    ANTI_GRAB_TELEPORT_DISTANCE = 10,
    
    -- çªè„¸æ‹¦æˆªç³»ç»Ÿ
    WARP_DETECTION_THRESHOLD = 15,
    WARP_COOLDOWN = 0.08,
    WARP_SPEED_LIMIT = 120,
    
    -- å‰§æƒ…æ€å…³é”®è¯
    SCRIPTED_DEATH_KEYWORDS = {
        "Kill", "Death", "Die", "Dead", "Execute",
        "ScriptedDeath", "StoryKill", "OneShot", "InstaKill",
        "AdminKill", "ForceDeath", "RemoteKill", "PlotDeath",
        "Murder", "Slay", "Destroy", "Terminate"
    },
    
    -- è¿œç¨‹æŒ‡ä»¤å…³é”®è¯
    REMOTE_BLOCK_KEYWORDS = {
        "Kill", "Death", "Destroy", "Explode", "Execute",
        "ForceKill", "ScriptedDeath", "StoryKill", "OneShot",
        "Instakill", "RemoteKill", "AdminKill", "SystemKill"
    },
    
    -- è§‚æˆ˜ç ´è§£å…³é”®è¯
    SPECTATOR_KEYWORDS = {
        "Spectator", "Spectate", "Observer", "Ghost",
        "CameraMode", "DeathCam", "DeadCam", "FollowCam",
        "è§‚æˆ˜", "æ—è§‚", "è§‚å¯Ÿè€…", "å¹½çµæ¨¡å¼"
    },
    
    -- è§’è‰²ä¿æŠ¤
    CRITICAL_BODY_PARTS = {
        "Head", "HumanoidRootPart", "Torso", "UpperTorso", 
        "LowerTorso", "Left Arm", "Right Arm", "Left Leg", "Right Leg"
    },
    
    -- æ€§èƒ½ä¼˜åŒ–
    MOBILE_OPTIMIZATION = true,
    CONNECTION_CLEANUP_INTERVAL = 25,
    MEMORY_USAGE_LIMIT = 200
}

-- ==================== å…¨å±€çŠ¶æ€ç®¡ç† ====================
local STATE = {
    Character = nil,
    Humanoid = nil,
    HumanoidRootPart = nil,
    
    IsInitialized = false,
    IsCharacterValid = false,
    IsRespawning = false,
    IsDead = false,
    
    DeathPositions = {},
    LastSafePosition = nil,
    LastValidCFrame = nil,
    LastValidHealth = 100,
    
    Connections = {
        Heal = {},
        AntiGrab = {},
        AntiWarp = {},
        AntiScriptedDeath = {},
        AntiDestroy = {},
        RemoteBlock = {},
        Respawn = {},
        Monitor = {},
        Utility = {}
    },
    
    BlockedRemotes = {},
    BlockedScripts = {},
    ProtectedInstances = {},
    
    LastCleanupTime = tick(),
    ConnectionCount = 0
}

-- ==================== å®‰å…¨å·¥å…·å‡½æ•°åº“ï¼ˆé¿å…å…ƒè¡¨é”™è¯¯ï¼‰====================
local SafeTools = {}

-- ç»å¯¹å®‰å…¨è°ƒç”¨ï¼ˆä½¿ç”¨xpcallï¼‰
function SafeTools.SafeExecute(func, ...)
    local success, result = xpcall(func, function(err)
        return tostring(err)
    end, ...)
    
    return success, result
end

-- å®‰å…¨åŒ…è£…å‡½æ•°
function SafeTools.WrapFunction(func)
    return function(...)
        local success, result = SafeTools.SafeExecute(func, ...)
        if not success then
            return nil
        end
        return result
    end
end

-- å®‰å…¨è·å–å®ä¾‹
function SafeTools.GetInstance(parent, name, className)
    if not parent then return nil end
    
    local function find()
        local instance = parent:FindFirstChild(name)
        if instance and (not className or instance:IsA(className)) then
            return instance
        end
        
        for _, child in ipairs(parent:GetChildren()) do
            if child.Name == name and (not className or child:IsA(className)) then
                return child
            end
        end
        return nil
    end
    
    local success, result = SafeTools.SafeExecute(find)
    return success and result or nil
end

-- å®‰å…¨æ–­å¼€è¿æ¥
function SafeTools.Disconnect(connection)
    if connection and typeof(connection) == "RBXScriptConnection" then
        SafeTools.SafeExecute(function()
            if connection.Connected then
                connection:Disconnect()
            end
        end)
    end
end

-- å®‰å…¨æ–­å¼€æ‰€æœ‰è¿æ¥
function SafeTools.DisconnectAll(connections)
    if type(connections) == "table" then
        for _, conn in ipairs(connections) do
            SafeTools.Disconnect(conn)
        end
        for i = 1, #connections do
            connections[i] = nil
        end
    end
end

-- å­—ç¬¦ä¸²å®‰å…¨åŒ¹é…
function SafeTools.StringMatch(str, patternList)
    if type(str) ~= "string" then return false end
    
    local lowerStr = string.lower(str)
    for _, pattern in ipairs(patternList) do
        if string.find(lowerStr, string.lower(pattern), 1, true) then
            return true
        end
    end
    return false
end

-- å¼ºåˆ¶è®¾ç½®å­˜æ´»ï¼ˆä¸ä¿®æ”¹åªè¯»å±æ€§ï¼‰
function SafeTools.ForceAlive(humanoid)
    if not humanoid then return false end
    
    return SafeTools.SafeExecute(function()
        -- å®‰å…¨è®¾ç½®è¡€é‡
        if humanoid.Health <= 0 then
            humanoid.Health = math.max(1, humanoid.MaxHealth * 0.7)
        end
        
        -- ä½¿ç”¨Attributeæ›¿ä»£ç›´æ¥ä¿®æ”¹åªè¯»å±æ€§
        humanoid:SetAttribute("IsDead", false)
        humanoid:SetAttribute("HealthState", "Alive")
        
        -- å°è¯•æ¸…é™¤æ­»äº¡çŠ¶æ€
        if humanoid:GetAttribute("Died") then
            humanoid:SetAttribute("Died", false)
        end
        
        return true
    end) or false
end

-- è®°å½•ä½ç½®
function SafeTools.RecordPosition(position)
    if not position then return end
    
    table.insert(STATE.DeathPositions, {
        Position = position,
        Time = tick()
    })
    
    while #STATE.DeathPositions > CONFIG.RESPAWN_POSITION_MEMORY do
        table.remove(STATE.DeathPositions, 1)
    end
    
    STATE.LastSafePosition = position
end

-- è·å–æœ€è¿‘ä½ç½®
function SafeTools.GetRecentPosition()
    if #STATE.DeathPositions > 0 then
        return STATE.DeathPositions[#STATE.DeathPositions].Position
    end
    return STATE.LastSafePosition or Vector3.new(0, 10, 0)
end

-- å®‰å…¨è®¾ç½®å±æ€§
function SafeTools.SetProperty(instance, property, value)
    return SafeTools.SafeExecute(function()
        instance[property] = value
        return true
    end) or false
end

-- ==================== æ ¸å¿ƒæ¨¡å—ï¼š9å€è‡ªåŠ¨å›è¡€ç³»ç»Ÿ ====================
local HealSystem = {}

function HealSystem.Initialize(humanoid)
    if not humanoid then return end
    
    SafeTools.DisconnectAll(STATE.Connections.Heal)
    
    -- è®¡ç®—å›è¡€ç‡
    local baseRate = humanoid.MaxHealth * CONFIG.HEAL_BASE_RATE
    local healPerSecond = baseRate * CONFIG.HEAL_MULTIPLIER
    
    -- ä¸»å›è¡€å¾ªç¯
    local healConn = RunService.Heartbeat:Connect(function(dt)
        if not humanoid or not humanoid.Parent then
            SafeTools.Disconnect(healConn)
            return
        end
        
        if not STATE.IsCharacterValid or humanoid.Health <= 0 then
            return
        end
        
        SafeTools.SafeExecute(function()
            -- è®¡ç®—å›è¡€é‡
            local healAmount = healPerSecond * dt
            
            -- ç´§æ€¥å›è¡€åŠ æˆ
            if humanoid.Health / humanoid.MaxHealth < CONFIG.EMERGENCY_HEAL_THRESHOLD then
                healAmount = healAmount * CONFIG.EMERGENCY_HEAL_BOOST
            end
            
            -- åº”ç”¨å›è¡€
            local newHealth = humanoid.Health + healAmount
            newHealth = math.min(newHealth, humanoid.MaxHealth, CONFIG.HEALTH_CAP)
            
            if newHealth < 1 then
                newHealth = math.max(1, humanoid.MaxHealth * 0.4)
            end
            
            humanoid.Health = newHealth
            
            -- æ›´æ–°è®°å½•
            if humanoid.Health > 0 then
                STATE.LastValidHealth = humanoid.Health
            end
        end)
    end)
    
    table.insert(STATE.Connections.Heal, healConn)
    
    -- è¡€é‡ç›‘æ§
    local monitorConn = humanoid:GetPropertyChangedSignal("Health"):Connect(function()
        SafeTools.SafeExecute(function()
            if humanoid.Health <= 0 and STATE.IsCharacterValid then
                humanoid.Health = math.max(1, humanoid.MaxHealth * 0.5)
            end
        end)
    end)
    
    table.insert(STATE.Connections.Heal, monitorConn)
    
    -- æ‰‹æœºè§¦æ‘¸å›è¡€
    if CONFIG.MOBILE_OPTIMIZATION then
        local touchConn = UserInputService.TouchTap:Connect(function(_, processed)
            if not processed and humanoid and STATE.IsCharacterValid then
                SafeTools.SafeExecute(function()
                    if humanoid.Health < humanoid.MaxHealth * 0.7 then
                        humanoid.Health = humanoid.Health + humanoid.MaxHealth * 0.2
                    end
                end)
            end
        end)
        
        table.insert(STATE.Connections.Heal, touchConn)
    end
end

-- ==================== æ ¸å¿ƒæ¨¡å—ï¼šæŠ“å–æ‹¦æˆªç³»ç»Ÿ ====================
local AntiGrabSystem = {}

function AntiGrabSystem.Initialize(character)
    if not character then return end
    
    SafeTools.DisconnectAll(STATE.Connections.AntiGrab)
    
    local rootPart = SafeTools.GetInstance(character, "HumanoidRootPart", "BasePart")
    if not rootPart then return end
    
    -- 1. æ‹¦æˆªå¼‚å¸¸è¿æ¥
    local jointConn = character.DescendantAdded:Connect(function(desc)
        if not STATE.IsCharacterValid then return end
        
        SafeTools.SafeExecute(function()
            local isJoint = desc:IsA("WeldConstraint") or desc:IsA("Weld") or desc:IsA("Motor6D")
            if isJoint then
                -- æ£€æŸ¥è¿æ¥å¯¹è±¡
                local part0 = desc.Part0
                local part1 = desc.Part1
                
                if part0 and not part0:IsDescendantOf(character) then
                    desc:Destroy()
                elseif part1 and not part1:IsDescendantOf(character) then
                    desc:Destroy()
                end
            end
        end)
    end)
    
    table.insert(STATE.Connections.AntiGrab, jointConn)
    
    -- 2. çˆ¶å¯¹è±¡ç›‘æ§
    local parentConn = rootPart:GetPropertyChangedSignal("Parent"):Connect(function()
        if not STATE.IsCharacterValid then return end
        
        SafeTools.SafeExecute(function()
            local currentParent = rootPart.Parent
            if currentParent and currentParent ~= character then
                if not currentParent:IsDescendantOf(Workspace) then
                    rootPart.Parent = character
                end
            end
        end)
    end)
    
    table.insert(STATE.Connections.AntiGrab, parentConn)
    
    -- 3. åŠ›åœºæ£€æµ‹å’Œæ‹¦æˆª
    local forceConn = RunService.Heartbeat:Connect(function()
        if not STATE.IsCharacterValid or not rootPart then return end
        
        SafeTools.SafeExecute(function()
            -- æ£€æµ‹é™„è¿‘åŠ›åœº
            local nearby = Workspace:GetPartsInPart(rootPart, OverlapParams.new())
            
            for _, part in ipairs(nearby) do
                if part.Parent ~= character then
                    -- æ£€æŸ¥åŠ›ç»„ä»¶
                    local bodyForce = part:FindFirstChildOfClass("BodyForce")
                    local bodyVelocity = part:FindFirstChildOfClass("BodyVelocity")
                    local bodyPosition = part:FindFirstChildOfClass("BodyPosition")
                    
                    -- æ£€æµ‹æŠ“å–åŠ›
                    if bodyForce and bodyForce.Force.Magnitude > CONFIG.GRAB_FORCE_THRESHOLD then
                        bodyForce:Destroy()
                        
                        -- æ¨å¼€æŠ“å–è€…
                        if part.Parent:FindFirstChildOfClass("Humanoid") then
                            local dir = (rootPart.Position - part.Position).Unit
                            part.Velocity = dir * CONFIG.ANTI_GRAB_PUSH_FORCE
                        end
                    end
                    
                    if bodyVelocity and bodyVelocity.Velocity.Magnitude > CONFIG.GRAB_FORCE_THRESHOLD then
                        bodyVelocity:Destroy()
                    end
                    
                    if bodyPosition and (bodyPosition.Position - rootPart.Position).Magnitude < 5 then
                        bodyPosition:Destroy()
                    end
                end
            end
        end)
    end)
    
    table.insert(STATE.Connections.AntiGrab, forceConn)
    
    -- 4. å¼‚å¸¸é€Ÿåº¦æ£€æµ‹ï¼ˆé˜²æ‹‰æ‰¯ï¼‰
    local velocityConn = RunService.Heartbeat:Connect(function()
        if not STATE.IsCharacterValid or not rootPart then return end
        
        SafeTools.SafeExecute(function()
            local speed = rootPart.Velocity.Magnitude
            if speed > 100 then -- å¼‚å¸¸é«˜é€Ÿ
                rootPart.Velocity = Vector3.new(0, 0, 0)
                rootPart.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
            end
            
            -- æ›´æ–°æœ‰æ•ˆä½ç½®
            STATE.LastValidCFrame = rootPart.CFrame
        end)
    end)
    
    table.insert(STATE.Connections.AntiGrab, velocityConn)
end

-- ==================== æ ¸å¿ƒæ¨¡å—ï¼šçªè„¸æ‹¦æˆªç³»ç»Ÿ ====================
local AntiWarpSystem = {}

function AntiWarpSystem.Initialize(character)
    if not character then return end
    
    SafeTools.DisconnectAll(STATE.Connections.AntiWarp)
    
    local rootPart = SafeTools.GetInstance(character, "HumanoidRootPart", "BasePart")
    if not rootPart then return end
    
    local lastPos = rootPart.Position
    local lastTime = tick()
    local warpLock = false
    
    local warpConn = RunService.Heartbeat:Connect(function()
        if not STATE.IsCharacterValid or not rootPart or warpLock then
            return
        end
        
        SafeTools.SafeExecute(function()
            local now = tick()
            local dt = now - lastTime
            
            -- è®¡ç®—ä½ç§»å’Œé€Ÿåº¦
            local currentPos = rootPart.Position
            local delta = (currentPos - lastPos).Magnitude
            local speed = delta / math.max(dt, 0.001)
            
            -- çªè„¸æ£€æµ‹
            local isWarping = false
            
            if speed > CONFIG.WARP_SPEED_LIMIT then
                isWarping = true
            elseif delta > CONFIG.WARP_DETECTION_THRESHOLD and dt < 0.05 then
                isWarping = true
            end
            
            -- æ‹¦æˆªå¤„ç†
            if isWarping then
                warpLock = true
                
                -- è¿˜åŸä½ç½®
                rootPart.CFrame = CFrame.new(lastPos) + CONFIG.RESPAWN_POSITION_OFFSET
                
                -- é‡ç½®ç‰©ç†çŠ¶æ€
                rootPart.Velocity = Vector3.new(0, 0, 0)
                rootPart.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
                rootPart.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
                
                -- çŸ­æš‚é”å®š
                wait(CONFIG.WARP_COOLDOWN)
                warpLock = false
            else
                -- æ­£å¸¸ç§»åŠ¨ï¼Œæ›´æ–°ä½ç½®
                lastPos = currentPos
            end
            
            lastTime = now
        end)
    end)
    
    table.insert(STATE.Connections.AntiWarp, warpConn)
end

-- ==================== æ ¸å¿ƒæ¨¡å—ï¼šå‰§æƒ…æ€æ‹¦æˆªç³»ç»Ÿï¼ˆå®‰å…¨ç‰ˆï¼‰====================
local AntiScriptedDeathSystem = {}

function AntiScriptedDeathSystem.Initialize(humanoid)
    if not humanoid then return end
    
    SafeTools.DisconnectAll(STATE.Connections.AntiScriptedDeath)
    
    -- ä½¿ç”¨å±æ€§ç›‘æ§æ›¿ä»£å…ƒè¡¨Hook
    local healthConn = humanoid:GetPropertyChangedSignal("Health"):Connect(function()
        if not STATE.IsCharacterValid then return end
        
        SafeTools.SafeExecute(function()
            -- é˜²æ­¢è¡€é‡è¢«è®¾ä¸º0æˆ–è´Ÿæ•°
            if humanoid.Health <= 0 then
                humanoid.Health = math.max(1, humanoid.MaxHealth * 0.8)
            end
            
            -- é˜²æ­¢å‰§æƒ…æ€é”è¡€
            if humanoid.Health > 0 and humanoid.Health < humanoid.MaxHealth * 0.15 then
                humanoid.Health = humanoid.MaxHealth * 0.5
            end
        end)
    end)
    
    table.insert(STATE.Connections.AntiScriptedDeath, healthConn)
    
    -- ç›‘æ§æœ€å¤§è¡€é‡
    local maxHealthConn = humanoid:GetPropertyChangedSignal("MaxHealth"):Connect(function()
        SafeTools.SafeExecute(function()
            if humanoid.MaxHealth < 60 then
                humanoid.MaxHealth = 120
            end
        end)
    end)
    
    table.insert(STATE.Connections.AntiScriptedDeath, maxHealthConn)
    
    -- ç›‘æ§æ­»äº¡äº‹ä»¶
    local diedConn = humanoid.Died:Connect(function()
        if STATE.IsCharacterValid then
            SafeTools.ForceAlive(humanoid)
        end
    end)
    
    table.insert(STATE.Connections.AntiScriptedDeath, diedConn)
    
    -- ç¦ç”¨æ­»äº¡ç›¸å…³è„šæœ¬
    local function DisableDeathScripts()
        SafeTools.SafeExecute(function()
            local containers = {
                LocalPlayer.PlayerScripts,
                Workspace,
                ReplicatedStorage,
                StarterPlayer.StarterPlayerScripts,
                StarterGui
            }
            
            for _, container in ipairs(containers) do
                if container then
                    for _, child in ipairs(container:GetDescendants()) do
                        if child:IsA("LocalScript") or child:IsA("Script") then
                            if SafeTools.StringMatch(child.Name, CONFIG.SCRIPTED_DEATH_KEYWORDS) then
                                child.Disabled = true
                                STATE.BlockedScripts[child] = true
                            end
                        end
                    end
                end
            end
        end)
    end
    
    -- åˆå§‹ç¦ç”¨
    DisableDeathScripts()
    
    -- ç›‘å¬æ–°è„šæœ¬
    local scriptConn = Workspace.DescendantAdded:Connect(function(desc)
        if desc:IsA("LocalScript") and SafeTools.StringMatch(desc.Name, CONFIG.SCRIPTED_DEATH_KEYWORDS) then
            SafeTools.SafeExecute(function()
                desc.Disabled = true
                STATE.BlockedScripts[desc] = true
            end)
        end
    end)
    
    table.insert(STATE.Connections.AntiScriptedDeath, scriptConn)
end

-- ==================== æ ¸å¿ƒæ¨¡å—ï¼šè§’è‰²é˜²é”€æ¯ç³»ç»Ÿ ====================
local AntiDestroySystem = {}

function AntiDestroySystem.Initialize(character)
    if not character then return end
    
    SafeTools.DisconnectAll(STATE.Connections.AntiDestroy)
    
    -- ç›‘å¬ç¥–å…ˆå˜åŒ–ï¼ˆæ£€æµ‹é”€æ¯ï¼‰
    local destroyConn = character.AncestryChanged:Connect(function(_, parent)
        if not parent and STATE.IsCharacterValid and not STATE.IsRespawning then
            STATE.IsRespawning = true
            
            -- è®°å½•ä½ç½®
            local rootPart = SafeTools.GetInstance(character, "HumanoidRootPart", "BasePart")
            if rootPart then
                SafeTools.RecordPosition(rootPart.Position)
            end
            
            -- å»¶è¿Ÿé‡ç”Ÿ
            wait(CONFIG.RESPAWN_DELAY)
            
            SafeTools.SafeExecute(function()
                LocalPlayer:LoadCharacter()
            end)
            
            STATE.IsRespawning = false
        end
    end)
    
    table.insert(STATE.Connections.AntiDestroy, destroyConn)
    
    -- æ ¸å¿ƒéƒ¨ä»¶ä¿æŠ¤
    local partConn = character.DescendantRemoving:Connect(function(desc)
        if not STATE.IsCharacterValid then return end
        
        SafeTools.SafeExecute(function()
            for _, partName in ipairs(CONFIG.CRITICAL_BODY_PARTS) do
                if desc.Name == partName and desc:IsA("BasePart") then
                    -- åˆ›å»ºæ›¿ä»£éƒ¨ä»¶
                    local newPart = Instance.new("Part")
                    newPart.Name = desc.Name
                    newPart.Size = desc.Size
                    newPart.CFrame = desc.CFrame
                    newPart.Anchored = false
                    newPart.CanCollide = true
                    newPart.Parent = character
                    
                    -- é‡æ–°ç»‘å®šHumanoid
                    if desc.Name == "HumanoidRootPart" then
                        local humanoid = SafeTools.GetInstance(character, "Humanoid", "Humanoid")
                        if humanoid then
                            humanoid.RootPart = newPart
                        end
                    end
                    
                    break
                end
            end
        end)
    end)
    
    table.insert(STATE.Connections.AntiDestroy, partConn)
    
    -- å®Œæ•´æ€§æ£€æŸ¥
    local integrityConn = RunService.Heartbeat:Connect(function()
        if not character or not character.Parent then return end
        
        SafeTools.SafeExecute(function()
            for _, partName in ipairs(CONFIG.CRITICAL_BODY_PARTS) do
                local part = character:FindFirstChild(partName)
                if not part or not part:IsA("BasePart") then
                    -- åˆ›å»ºç¼ºå¤±éƒ¨ä»¶
                    local newPart = Instance.new("Part")
                    newPart.Name = partName
                    
                    if partName == "Head" then
                        newPart.Size = Vector3.new(2, 2, 2)
                    elseif partName == "HumanoidRootPart" then
                        newPart.Size = Vector3.new(2, 2, 1)
                    else
                        newPart.Size = Vector3.new(2, 2, 1)
                    end
                    
                    local rootPart = character:FindFirstChild("HumanoidRootPart")
                    if rootPart then
                        newPart.CFrame = rootPart.CFrame
                    else
                        newPart.CFrame = CFrame.new(0, 5, 0)
                    end
                    
                    newPart.Anchored = false
                    newPart.CanCollide = true
                    newPart.Parent = character
                    
                    if partName == "HumanoidRootPart" then
                        local humanoid = SafeTools.GetInstance(character, "Humanoid", "Humanoid")
                        if humanoid then
                            humanoid.RootPart = newPart
                        end
                    end
                end
            end
        end)
    end)
    
    table.insert(STATE.Connections.AntiDestroy, integrityConn)
end

-- ==================== æ ¸å¿ƒæ¨¡å—ï¼šè¿œç¨‹æŒ‡ä»¤æ‹¦æˆªç³»ç»Ÿï¼ˆå®‰å…¨ç‰ˆï¼‰====================
local RemoteBlockSystem = {}

function RemoteBlockSystem.Initialize()
    SafeTools.DisconnectAll(STATE.Connections.RemoteBlock)
    
    -- å®‰å…¨æ‹¦æˆªå‡½æ•°
    local function SafeBlockRemote(remote, player)
        if not remote or not player then return false end
        
        -- æ£€æŸ¥è¿œç¨‹åç§°
        if SafeTools.StringMatch(remote.Name, CONFIG.REMOTE_BLOCK_KEYWORDS) then
            -- æ ‡è®°ä¸ºå·²æ‹¦æˆª
            STATE.BlockedRemotes[remote] = true
            
            -- å¯¹äºRemoteEventï¼Œä½¿ç”¨å®‰å…¨çš„æ–¹æ³•
            if remote:IsA("RemoteEvent") then
                SafeTools.SafeExecute(function()
                    -- è·å–è¿æ¥å¹¶å®‰å…¨å¤„ç†
                    local connections = getconnections(remote.OnClientEvent)
                    for _, conn in ipairs(connections) do
                        SafeTools.Disconnect(conn)
                    end
                end)
                
                -- è®¾ç½®å®‰å…¨çš„äº‹ä»¶å¤„ç†å™¨
                remote.OnClientEvent = SafeTools.WrapFunction(function(...)
                    local args = {...}
                    local shouldBlock = false
                    
                    for _, arg in ipairs(args) do
                        if arg == LocalPlayer then
                            shouldBlock = true
                            break
                        end
                    end
                    
                    if shouldBlock then
                        if STATE.Humanoid then
                            SafeTools.ForceAlive(STATE.Humanoid)
                        end
                        return nil
                    end
                end)
            end
            
            -- å¯¹äºRemoteFunction
            if remote:IsA("RemoteFunction") then
                local originalInvoke = remote.InvokeClient
                if originalInvoke then
                    remote.InvokeClient = SafeTools.WrapFunction(function(...)
                        local args = {...}
                        local shouldBlock = false
                        
                        for _, arg in ipairs(args) do
                            if arg == LocalPlayer then
                                shouldBlock = true
                                break
                            end
                        end
                        
                        if shouldBlock then
                            if STATE.Humanoid then
                                SafeTools.ForceAlive(STATE.Humanoid)
                            end
                            return nil
                        end
                        
                        return originalInvoke(...)
                    end)
                end
            end
            
            return true
        end
        
        return false
    end
    
    -- æ‰«æè¿œç¨‹å¯¹è±¡
    local function ScanForRemotes()
        SafeTools.SafeExecute(function()
            local containers = {
                ReplicatedStorage,
                Workspace,
                StarterPack,
                StarterGui,
                LocalPlayer.PlayerScripts,
                LocalPlayer.Backpack
            }
            
            for _, container in ipairs(containers) do
                if container then
                    for _, child in ipairs(container:GetDescendants()) do
                        if (child:IsA("RemoteEvent") or child:IsA("RemoteFunction")) and not STATE.BlockedRemotes[child] then
                            SafeBlockRemote(child, LocalPlayer)
                        end
                    end
                end
            end
        end)
    end
    
    -- åˆå§‹æ‰«æ
    ScanForRemotes()
    
    -- ç›‘å¬æ–°è¿œç¨‹å¯¹è±¡
    local remoteConn = ReplicatedStorage.DescendantAdded:Connect(function(desc)
        if (desc:IsA("RemoteEvent") or desc:IsA("RemoteFunction")) and not STATE.BlockedRemotes[desc] then
            SafeTools.SafeExecute(function()
                SafeBlockRemote(desc, LocalPlayer)
            end)
        end
    end)
    
    table.insert(STATE.Connections.RemoteBlock, remoteConn)
    
    -- å®šæœŸæ‰«æ
    local scanConn = RunService.Heartbeat:Connect(function()
        if tick() % 15 < 0.1 then
            ScanForRemotes()
        end
    end)
    
    table.insert(STATE.Connections.RemoteBlock, scanConn)
end

-- ==================== æ ¸å¿ƒæ¨¡å—ï¼šæ— é™é‡ç”Ÿç³»ç»Ÿ ====================
local RespawnSystem = {}

function RespawnSystem.Initialize(character)
    if not character then return end
    
    SafeTools.DisconnectAll(STATE.Connections.Respawn)
    
    local humanoid = SafeTools.GetInstance(character, "Humanoid", "Humanoid")
    if not humanoid then return end
    
    -- è®°å½•åˆå§‹ä½ç½®
    local rootPart = SafeTools.GetInstance(character, "HumanoidRootPart", "BasePart")
    if rootPart then
        SafeTools.RecordPosition(rootPart.Position)
    end
    
    -- æ­»äº¡äº‹ä»¶å¤„ç†
    local diedConn = humanoid.Died:Connect(function()
        if STATE.IsRespawning then return end
        
        STATE.IsRespawning = true
        STATE.IsDead = true
        
        -- è®°å½•æ­»äº¡ä½ç½®
        local deathRoot = SafeTools.GetInstance(character, "HumanoidRootPart", "BasePart")
        if deathRoot then
            SafeTools.RecordPosition(deathRoot.Position)
        end
        
        -- ç ´è§£é‡ç”Ÿé™åˆ¶
        SafeTools.SafeExecute(function()
            LocalPlayer:SetAttribute("CanRespawn", true)
            LocalPlayer:SetAttribute("RespawnLimit", math.huge)
            LocalPlayer:SetAttribute("OneLife", false)
            LocalPlayer:SetAttribute("NoRespawn", false)
            LocalPlayer:SetAttribute("InfiniteLives", true)
            
            -- ç ´è§£é‡ç”Ÿè®¡æ—¶å™¨
            local respawnService = game:GetService("ReplicatedFirst"):FindFirstChild("RespawnService")
            if respawnService then
                respawnService:SetAttribute("RespawnTime", 0)
            end
        end)
        
        -- å»¶è¿Ÿé‡ç”Ÿ
        wait(CONFIG.RESPAWN_DELAY)
        
        -- å¼ºåˆ¶é‡ç”Ÿ
        for i = 1, CONFIG.FORCE_RESPAWN_ATTEMPTS do
            local success = SafeTools.SafeExecute(function()
                LocalPlayer:LoadCharacter()
                return true
            end)
            
            if success then break end
            wait(0.1)
        end
        
        STATE.IsRespawning = false
        STATE.IsDead = false
    end)
    
    table.insert(STATE.Connections.Respawn, diedConn)
    
    -- é‡ç”Ÿä½ç½®è®¾ç½®
    local charConn = LocalPlayer.CharacterAdded:Connect(function(newChar)
        wait(0.5)
        
        if newChar and newChar:IsDescendantOf(Workspace) then
            local newRoot = SafeTools.GetInstance(newChar, "HumanoidRootPart", "BasePart")
            if newRoot then
                SafeTools.SafeExecute(function()
                    local respawnPos = SafeTools.GetRecentPosition()
                    newRoot.CFrame = CFrame.new(respawnPos + CONFIG.RESPAWN_POSITION_OFFSET)
                end)
            end
        end
    end)
    
    table.insert(STATE.Connections.Respawn, charConn)
end

-- ==================== æ ¸å¿ƒæ¨¡å—ï¼šè§‚æˆ˜ç ´è§£ç³»ç»Ÿ ====================
local SpectatorBypassSystem = {}

function SpectatorBypassSystem.Initialize()
    -- ç¦ç”¨è§‚æˆ˜UI
    local function DisableSpectatorUI()
        SafeTools.SafeExecute(function()
            local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
            if playerGui then
                for _, gui in ipairs(playerGui:GetChildren()) do
                    if gui:IsA("ScreenGui") then
                        if SafeTools.StringMatch(gui.Name, CONFIG.SPECTATOR_KEYWORDS) then
                            gui.Enabled = false
                        end
                    end
                end
            end
        end)
    end
    
    -- ç¦ç”¨è§‚æˆ˜è„šæœ¬
    local function DisableSpectatorScripts()
        SafeTools.SafeExecute(function()
            local containers = {
                LocalPlayer.PlayerScripts,
                Workspace,
                ReplicatedStorage
            }
            
            for _, container in ipairs(containers) do
                if container then
                    for _, script in ipairs(container:GetDescendants()) do
                        if script:IsA("LocalScript") then
                            if SafeTools.StringMatch(script.Name, CONFIG.SPECTATOR_KEYWORDS) then
                                script.Disabled = true
                            end
                        end
                    end
                end
            end
        end)
    end
    
    -- ç ´è§£è§‚æˆ˜çŠ¶æ€
    local function BypassSpectator()
        SafeTools.SafeExecute(function()
            LocalPlayer:SetAttribute("Spectating", false)
            LocalPlayer:SetAttribute("InSpectatorMode", false)
            LocalPlayer:SetAttribute("IsObserver", false)
            
            -- å¼ºåˆ¶ç›¸æœºæ¨¡å¼
            local camera = Workspace.CurrentCamera
            if camera then
                camera.CameraType = Enum.CameraType.Custom
                
                if LocalPlayer.Character then
                    local humanoid = SafeTools.GetInstance(LocalPlayer.Character, "Humanoid", "Humanoid")
                    if humanoid then
                        camera.CameraSubject = humanoid
                    end
                end
            end
        end)
    end
    
    -- åˆå§‹æ‰§è¡Œ
    DisableSpectatorUI()
    DisableSpectatorScripts()
    BypassSpectator()
    
    -- å®šæœŸæ£€æŸ¥
    local checkConn = RunService.Heartbeat:Connect(function()
        BypassSpectator()
        
        if tick() % 8 < 0.1 then
            DisableSpectatorUI()
        end
    end)
    
    table.insert(STATE.Connections.Monitor, checkConn)
end

-- ==================== è§’è‰²å¼ºåŒ–ç³»ç»Ÿ ====================
local CharacterEnhancer = {}

function CharacterEnhancer.Initialize(character)
    if not character then return end
    
    local humanoid = SafeTools.GetInstance(character, "Humanoid", "Humanoid")
    if not humanoid then return end
    
    SafeTools.SafeExecute(function()
        -- ç”Ÿå‘½å€¼å¼ºåŒ–
        humanoid.MaxHealth = math.max(150, humanoid.MaxHealth * 1.8)
        humanoid.Health = humanoid.MaxHealth
        
        -- ç§»åŠ¨å¼ºåŒ–
        humanoid.WalkSpeed = math.min(36, humanoid.WalkSpeed * 1.3)
        humanoid.JumpPower = math.min(80, humanoid.JumpPower * 1.2)
        
        -- å…¶ä»–å¼ºåŒ–
        humanoid.AutoRotate = true
        humanoid.AutoJumpEnabled = true
        humanoid.BreakJointsOnDeath = false
        
        -- è®¾ç½®é‡ç”Ÿç‚¹
        local rootPart = SafeTools.GetInstance(character, "HumanoidRootPart", "BasePart")
        if rootPart then
            local spawnMarker = Instance.new("Part")
            spawnMarker.Name = "RespawnMarker"
            spawnMarker.Size = Vector3.new(1, 1, 1)
            spawnMarker.CFrame = rootPart.CFrame
            spawnMarker.Anchored = true
            spawnMarker.CanCollide = false
            spawnMarker.Transparency = 1
            spawnMarker.Parent = Workspace
            
            -- 5ç§’åæ¸…ç†
            delay(5, function()
                SafeTools.SafeExecute(function()
                    spawnMarker:Destroy()
                end)
            end)
        end
    end)
end

-- ==================== è§’è‰²åˆå§‹åŒ–ç³»ç»Ÿ ====================
local function InitializeCharacter(character)
    if not character or not character:IsDescendantOf(Workspace) then
        return
    end
    
    -- ç­‰å¾…ç»„ä»¶åŠ è½½
    local humanoid, rootPart
    local startTime = tick()
    
    while tick() - startTime < 10 do
        humanoid = SafeTools.GetInstance(character, "Humanoid", "Humanoid")
        rootPart = SafeTools.GetInstance(character, "HumanoidRootPart", "BasePart")
        
        if humanoid and rootPart then
            break
        end
        wait(0.1)
    end
    
    if not humanoid or not rootPart then
        return
    end
    
    -- æ›´æ–°çŠ¶æ€
    STATE.Character = character
    STATE.Humanoid = humanoid
    STATE.HumanoidRootPart = rootPart
    STATE.IsCharacterValid = true
    STATE.LastValidCFrame = rootPart.CFrame
    
    -- è§’è‰²å¼ºåŒ–
    CharacterEnhancer.Initialize(character)
    
    -- åˆå§‹åŒ–æ‰€æœ‰ç³»ç»Ÿ
    HealSystem.Initialize(humanoid)
    AntiGrabSystem.Initialize(character)
    AntiWarpSystem.Initialize(character)
    AntiScriptedDeathSystem.Initialize(humanoid)
    AntiDestroySystem.Initialize(character)
    RemoteBlockSystem.Initialize()
    RespawnSystem.Initialize(character)
    SpectatorBypassSystem.Initialize()
    
    -- è§’è‰²ç›‘æ§
    local monitorConn = RunService.Heartbeat:Connect(function()
        if not character or not character:IsDescendantOf(Workspace) then
            STATE.IsCharacterValid = false
            
            SafeTools.SafeExecute(function()
                LocalPlayer:LoadCharacter()
            end)
            return
        end
        
        -- æ£€æŸ¥ç”Ÿå‘½å€¼
        if humanoid and humanoid.Health <= 0 then
            SafeTools.ForceAlive(humanoid)
        end
        
        -- æ›´æ–°ä½ç½®
        if rootPart then
            STATE.LastValidCFrame = rootPart.CFrame
        end
        
        -- æ¸…ç†è¿æ¥
        if tick() - STATE.LastCleanupTime > CONFIG.CONNECTION_CLEANUP_INTERVAL then
            STATE.LastCleanupTime = tick()
            STATE.ConnectionCount = 0
            
            for _, connections in pairs(STATE.Connections) do
                if type(connections) == "table" then
                    STATE.ConnectionCount = STATE.ConnectionCount + #connections
                end
            end
        end
    end)
    
    table.insert(STATE.Connections.Monitor, monitorConn)
end

-- ==================== å…¨å±€åˆå§‹åŒ– ====================
local function GlobalInitialize()
    if STATE.IsInitialized then return end
    
    print("[åˆå§‹åŒ–] å¼€å§‹åˆå§‹åŒ–è„šæœ¬...")
    
    -- æ¸…ç†æ—§çŠ¶æ€
    for _, connections in pairs(STATE.Connections) do
        SafeTools.DisconnectAll(connections)
    end
    
    STATE.BlockedRemotes = {}
    STATE.BlockedScripts = {}
    STATE.ProtectedInstances = {}
    
    -- ç­‰å¾…ç©å®¶
    if not LocalPlayer then
        repeat wait() until PlayerService.LocalPlayer
        LocalPlayer = PlayerService.LocalPlayer
    end
    
    -- ç»‘å®šè§’è‰²äº‹ä»¶
    local charConn = LocalPlayer.CharacterAdded:Connect(function(char)
        wait(0.5)
        InitializeCharacter(char)
    end)
    
    table.insert(STATE.Connections.Utility, charConn)
    
    -- å¤„ç†ç°æœ‰è§’è‰²
    if LocalPlayer.Character then
        wait(1)
        InitializeCharacter(LocalPlayer.Character)
    else
        wait(2)
        SafeTools.SafeExecute(function()
            LocalPlayer:LoadCharacter()
        end)
    end
    
    -- é”™è¯¯å¤„ç†
    local errorConn = ScriptContext.Error:Connect(function(err)
        print("[è„šæœ¬é”™è¯¯]", err)
        
        wait(1)
        if STATE.Character and STATE.Character:IsDescendantOf(Workspace) then
            InitializeCharacter(STATE.Character)
        else
            SafeTools.SafeExecute(function()
                LocalPlayer:LoadCharacter()
            end)
        end
    end)
    
    table.insert(STATE.Connections.Utility, errorConn)
    
    -- æ‰‹æœºä¼˜åŒ–
    if CONFIG.MOBILE_OPTIMIZATION then
        SafeTools.SafeExecute(function()
            settings().Rendering.QualityLevel = 2
            Lighting.GlobalShadows = false
            Lighting.FogEnd = 1500
            settings().Physics.PhysicsEnvironmentalThrottle = 1
        end)
    end
    
    STATE.IsInitialized = true
    
    -- å®Œæˆæç¤º
    delay(3, function()
        print("\n" .. string.rep("=", 65))
        print("ğŸ“± æ‰‹æœºç«¯é€šç”¨è¶…å¼ºç”Ÿå­˜è„šæœ¬ - åŠ è½½å®Œæˆ")
        print(string.rep("-", 65))
        print("ğŸ”¥ æ ¸å¿ƒåŠŸèƒ½ï¼ˆå·²ä¿®å¤å…ƒè¡¨é”™è¯¯ï¼‰:")
        print("   âœ… 9å€è‡ªåŠ¨å›è¡€ç³»ç»Ÿï¼ˆç´§æ€¥çŠ¶æ€é¢å¤–åŠ é€Ÿï¼‰")
        print("   âœ… åŸåœ°æ— é™é‡ç”Ÿç³»ç»Ÿï¼ˆç²¾å‡†ä½ç½®è¿˜åŸï¼‰")
        print("   âœ… å…¨ç»´åº¦æŠ“å–æ‹¦æˆªç³»ç»Ÿï¼ˆ4é‡é˜²å¾¡æœºåˆ¶ï¼‰")
        print("   âœ… æ­»äº¡çªè„¸å¼ºåˆ¶æ‹¦æˆªç³»ç»Ÿï¼ˆä½ç½®é”å®šï¼‰")
        print("   âœ… å‰§æƒ…æ€100%æ‹¦æˆªç³»ç»Ÿï¼ˆå®‰å…¨å±æ€§ç›‘æ§ï¼‰")
        print("   âœ… è§’è‰²é˜²é”€æ¯ç³»ç»Ÿï¼ˆæ ¸å¿ƒéƒ¨ä»¶è‡ªåŠ¨ä¿®å¤ï¼‰")
        print("   âœ… è¿œç¨‹æŒ‡ä»¤æ‹¦æˆªç³»ç»Ÿï¼ˆå…³é”®è¯åŒ¹é…ï¼‰")
        print("   âœ… å¼ºåˆ¶ç ´è§£ä¸€å‘½é‡ç”Ÿ+è§‚æˆ˜ç³»ç»Ÿ")
        print(string.rep("-", 65))
        print("âš¡ ä¼˜åŒ–ç‰¹æ€§:")
        print("   â€¢ æ‰‹æœºç«¯è§¦æ‘¸å›è¡€æ”¯æŒ")
        print("   â€¢ å…¨å±€é”™è¯¯è‡ªåŠ¨æ¢å¤")
        print("   â€¢ å†…å­˜å’Œè¿æ¥æ™ºèƒ½ç®¡ç†")
        print("   â€¢ å…¨Robloxæ¸¸æˆé€šç”¨é€‚é…")
        print("   â€¢ å®Œå…¨é¿å…åªè¯»è¡¨ä¿®æ”¹é”™è¯¯")
        print(string.rep("=", 65))
    end)
end

-- ==================== å¯åŠ¨è„šæœ¬ ====================
-- ä½¿ç”¨åç¨‹å¯åŠ¨ï¼Œé˜²æ­¢é˜»å¡
coroutine.wrap(function()
    -- ç­‰å¾…æ¸¸æˆåŠ è½½
    wait(2)
    
    -- æ£€æŸ¥æ¸¸æˆçŠ¶æ€
    local gameLoaded = SafeTools.SafeExecute(function()
        return game:IsLoaded()
    end)
    
    if not gameLoaded then
        repeat wait() until game:IsLoaded()
    end
    
    -- æ‰§è¡Œåˆå§‹åŒ–
    GlobalInitialize()
end)()

-- è¿”å›è„šæœ¬æ¥å£
return {
    Version = "4.0",
    Status = function()
        return {
            Initialized = STATE.IsInitialized,
            CharacterValid = STATE.IsCharacterValid,
            Health = STATE.Humanoid and STATE.Humanoid.Health or 0,
            MaxHealth = STATE.Humanoid and STATE.Humanoid.MaxHealth or 0,
            DeathPositions = #STATE.DeathPositions,
            BlockedRemotes = #STATE.BlockedRemotes
        }
    end,
    
    Reinitialize = function()
        STATE.IsInitialized = false
        GlobalInitialize()
    end,
    
    ForceRespawn = function()
        if STATE.Character then
            local rootPart = SafeTools.GetInstance(STATE.Character, "HumanoidRootPart", "BasePart")
            if rootPart then
                SafeTools.RecordPosition(rootPart.Position)
            end
        end
        SafeTools.SafeExecute(function()
            LocalPlayer:LoadCharacter()
        end)
    end,
    
    GetConfig = function()
        return CONFIG
    end
}
]])()
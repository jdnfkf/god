-- ==============================================
-- 手机端无敌最终版核心脚本（完整功能）- 修复版
-- 密钥：nb666 | 支持悬浮按钮/震动/自动回血/防摔死
-- ==============================================

-- 配置项
local AUTHORIZED_KEY = "nb666"
local MAX_ATTEMPTS = 3
local TIMEOUT = 60
local plr = game.Players.LocalPlayer
local pg = plr:WaitForChild("PlayerGui")
local isAuthenticated = false
local isInvincible = false
local ff = nil
local deathPosition = nil  -- 新增：记录死亡位置

-- 1. 密钥验证逻辑（修复：使用 task.wait 避免阻塞）
local attempts = 0
local function verifyKey(input)
    if input == AUTHORIZED_KEY then 
        return true 
    end
    attempts += 1
    warn("密钥错误！剩余尝试：" .. (MAX_ATTEMPTS - attempts))
    if attempts >= MAX_ATTEMPTS then
        warn("尝试次数用尽，脚本锁定！")
        return false
    end
    return false
end

-- 2. 密钥输入UI（修复：添加防重复创建）
local function showAuthUI()
    -- 清理旧UI
    local oldUI = pg:FindFirstChild("AuthUI")
    if oldUI then oldUI:Destroy() end
    
    local sg = Instance.new("ScreenGui")
    sg.Name = "AuthUI"
    sg.Parent = pg

    -- 背景框
    local bg = Instance.new("Frame")
    bg.Size = UDim2.new(0, 320, 0, 220)
    bg.Position = UDim2.new(0.5, -160, 0.5, -110)
    bg.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
    bg.BackgroundTransparency = 0.2
    bg.Parent = sg

    -- 标题
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 40)
    title.Text = "请输入密钥"
    title.Font = Enum.Font.SourceSans
    title.TextSize = 24
    title.TextColor3 = Color3.new(1, 1, 1)
    title.BackgroundTransparency = 1
    title.Parent = bg

    -- 输入框
    local tb = Instance.new("TextBox")
    tb.Size = UDim2.new(0.8, 0, 0, 40)
    tb.Position = UDim2.new(0.1, 0, 0.3, 0)
    tb.PlaceholderText = "密钥提示：nb666"
    tb.ClearTextOnFocus = false
    tb.Font = Enum.Font.SourceSans
    tb.TextSize = 20
    tb.Parent = bg

    -- 验证按钮
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0.6, 0, 0, 35)
    btn.Position = UDim2.new(0.2, 0, 0.6, 0)
    btn.Text = "验证"
    btn.Font = Enum.Font.SourceSans
    btn.TextSize = 18
    btn.BackgroundColor3 = Color3.new(0.2, 0.6, 1)
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.Parent = bg

    -- 倒计时文本
    local timer = Instance.new("TextLabel")
    timer.Size = UDim2.new(1, 0, 0, 20)
    timer.Position = UDim2.new(0, 0, 0.85, 0)
    timer.Text = "剩余时间：" .. TIMEOUT .. "秒"
    timer.Font = Enum.Font.SourceSans
    timer.TextSize = 16
    timer.TextColor3 = Color3.new(1, 1, 1)
    timer.BackgroundTransparency = 1
    timer.Parent = bg

    -- 倒计时逻辑（修复：使用正确的计时方式）
    local startTime = tick()
    local connection
    connection = game:GetService("RunService").Heartbeat:Connect(function()
        if not isAuthenticated then
            local elapsed = tick() - startTime
            local left = math.max(0, TIMEOUT - math.floor(elapsed))
            timer.Text = "剩余时间：" .. left .. "秒"
            if left <= 0 then
                warn("超时未输入，脚本锁定！")
                if connection then connection:Disconnect() end
                sg:Destroy()
            end
        else
            if connection then connection:Disconnect() end
        end
    end)

    -- 验证按钮点击事件（修复：添加防重复点击）
    local isProcessing = false
    btn.MouseButton1Click:Connect(function()
        if isProcessing then return end
        isProcessing = true
        
        if verifyKey(tb.Text) then
            isAuthenticated = true
            if connection then connection:Disconnect() end
            sg:Destroy()
            spawnMainUI()
        else
            -- 震动提示（如果支持）
            pcall(function()
                game:GetService("UserInputService"):Vibrate(0.1)
            end)
        end
        
        task.wait(0.5)
        isProcessing = false
    end)
end

-- 3. 真正的无敌核心功能（修复多个问题）
local function toggleInvincible()
    isInvincible = not isInvincible
    local char = plr.Character
    if not char then 
        warn("角色不存在")
        return 
    end
    
    local hum = char:FindFirstChild("Humanoid")
    if not hum then 
        warn("Humanoid 不存在")
        return 
    end

    if isInvincible then
        -- 开启无敌（修复：更可靠的实现）
        print("开启无敌模式")
        
        -- 1. 创建隐藏力场
        if ff then ff:Destroy() end
        ff = Instance.new("ForceField")
        ff.Visible = false
        ff.Parent = char
        
        -- 2. 设置无敌属性（修复：避免 HealthChanged 循环）
        local healthChangedConnection
        healthChangedConnection = hum.HealthChanged:Connect(function(newHealth)
            if newHealth < hum.MaxHealth then
                hum.Health = hum.MaxHealth
            end
        end)
        
        -- 存储连接以便清理
        char:SetAttribute("InvincibleConnection", healthChangedConnection)
        
        -- 3. 记录死亡位置（新增功能）
        hum.Died:Connect(function()
            -- 记录死亡位置
            local hrp = char:FindFirstChild("HumanoidRootPart")
            if hrp then
                deathPosition = hrp.Position
                print("死亡位置已记录: " .. tostring(deathPosition))
            end
            
            -- 等待重生
            task.wait(0.5)
            
            -- 重生后重新应用无敌
            local newChar = plr.Character
            if newChar and isInvincible then
                task.wait(0.2) -- 等待角色完全加载
                
                local newHum = newChar:FindFirstChild("Humanoid")
                local newHrp = newChar:FindFirstChild("HumanoidRootPart")
                
                if newHum and newHrp then
                    -- 重新创建力场
                    if ff then ff:Destroy() end
                    ff = Instance.new("ForceField")
                    ff.Visible = false
                    ff.Parent = newChar
                    
                    -- 重新连接生命值监控
                    local newHealthConn = newHum.HealthChanged:Connect(function(newHealth)
                        if newHealth < newHum.MaxHealth then
                            newHum.Health = newHum.MaxHealth
                        end
                    end)
                    newChar:SetAttribute("InvincibleConnection", newHealthConn)
                    
                    -- 传送到死亡位置（新增功能）
                    if deathPosition then
                        task.wait(0.1) -- 确保角色完全生成
                        newHrp.CFrame = CFrame.new(deathPosition + Vector3.new(0, 5, 0))
                        print("已传送到死亡位置")
                    end
                end
            end
        end)
        
        -- 4. 设置生命值为最大值
        hum.MaxHealth = math.huge
        hum.Health = hum.MaxHealth
        
        -- 5. 禁用死亡状态（如果可能）
        pcall(function()
            hum:SetStateEnabled(Enum.HumanoidStateType.Dead, false)
        end)
        
        -- 6. 震动反馈
        pcall(function()
            game:GetService("UserInputService"):Vibrate(100)
        end)
        
    else
        -- 关闭无敌（修复：正确清理）
        print("关闭无敌模式")
        
        if ff then 
            ff:Destroy() 
            ff = nil
        end
        
        -- 清理连接
        if char then
            local conn = char:GetAttribute("InvincibleConnection")
            if conn then
                conn:Disconnect()
                char:SetAttribute("InvincibleConnection", nil)
            end
        end
        
        -- 恢复默认设置
        hum.MaxHealth = 100
        hum.Health = math.min(hum.Health, 100)
        
        pcall(function()
            hum:SetStateEnabled(Enum.HumanoidStateType.Dead, true)
        end)
        
        -- 震动反馈
        pcall(function()
            game:GetService("UserInputService"):Vibrate(50)
        end)
    end
end

-- 4. 自动回血+防摔死（优化版）
local autoHealConnection
autoHealConnection = game:GetService("RunService").Heartbeat:Connect(function()
    local char = plr.Character
    if not char then return end
    
    local hum = char:FindFirstChild("Humanoid")
    if not hum then return end
    
    -- 自动回血（只在非无敌模式下工作）
    if not isInvincible and hum.Health < hum.MaxHealth then
        hum.Health = hum.MaxHealth
    end
    
    -- 防摔死（避免掉落伤害）
    pcall(function()
        hum.FloorMaterial = Enum.Material.Air
    end)
    
    -- 防止强制死亡（额外保护层）
    if hum.Health <= 0 and not isInvincible then
        hum.Health = 1
    end
end)

-- 5. 手机悬浮按钮UI（可拖动）- 修复版
local function spawnMainUI()
    -- 清理旧UI
    local oldUI = pg:FindFirstChild("MainUI")
    if oldUI then oldUI:Destroy() end
    
    local sg = Instance.new("ScreenGui")
    sg.Name = "MainUI"
    sg.Parent = pg

    -- 主按钮容器（添加圆角）
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 120, 0, 50)
    btn.Position = UDim2.new(0.05, 0, 0.8, 0)
    btn.Text = "开启无敌"
    btn.Font = Enum.Font.SourceSansBold
    btn.TextSize = 18
    btn.BackgroundColor3 = Color3.new(1, 0.3, 0.3)
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.BackgroundTransparency = 0.2
    btn.Parent = sg
    
    -- 添加圆角
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = btn

    -- 按钮拖动功能（修复：改进触摸交互）
    local dragging = false
    local startPos = nil
    local dragOffset = nil
    
    btn.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            startPos = input.Position
            dragOffset = btn.AbsolutePosition - startPos
            
            -- 视觉反馈
            btn.BackgroundTransparency = 0.4
        end
    end)
    
    game:GetService("UserInputService").InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.Touch then
            local newPos = input.Position + dragOffset
            btn.Position = UDim2.new(
                0, newPos.X,
                0, newPos.Y
            )
        end
    end)
    
    game:GetService("UserInputService").InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
            btn.BackgroundTransparency = 0.2
        end
    end)

    -- 开关无敌点击事件（修复：添加防重复触发）
    local isToggling = false
    btn.MouseButton1Click:Connect(function()
        if isToggling then return end
        isToggling = true
        
        toggleInvincible()
        btn.Text = isInvincible and "关闭无敌" or "开启无敌"
        btn.BackgroundColor3 = isInvincible and Color3.new(0.3, 1, 0.3) or Color3.new(1, 0.3, 0.3)
        
        -- 点击反馈
        local originalSize = btn.Size
        btn.Size = UDim2.new(0, 115, 0, 45)
        task.wait(0.1)
        btn.Size = originalSize
        
        task.wait(0.3)
        isToggling = false
    end)
    
    -- 添加一个关闭按钮（可选）
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 30, 0, 30)
    closeBtn.Position = UDim2.new(0, 5, 0, 5)
    closeBtn.Text = "X"
    closeBtn.Font = Enum.Font.SourceSansBold
    closeBtn.TextSize = 16
    closeBtn.BackgroundColor3 = Color3.new(1, 0, 0)
    closeBtn.TextColor3 = Color3.new(1, 1, 1)
    closeBtn.BackgroundTransparency = 0.3
    closeBtn.Parent = sg
    
    closeBtn.MouseButton1Click:Connect(function()
        sg:Destroy()
        -- 关闭无敌状态
        if isInvincible then
            toggleInvincible()
        end
    end)
end

-- 6. 初始化和错误处理
local function initialize()
    -- 等待游戏完全加载
    task.wait(1)
    
    -- 检查是否已有UI
    if pg:FindFirstChild("AuthUI") then
        pg.AuthUI:Destroy()
    end
    
    -- 显示验证界面
    showAuthUI()
    
    -- 添加错误处理
    game:GetService("ScriptContext").Error:Connect(function(message, trace)
        warn("脚本错误: " .. message)
    end)
end

-- 7. 延迟启动（确保游戏已加载）
task.wait(2)
initialize()

print("无敌脚本已加载 - 等待验证")
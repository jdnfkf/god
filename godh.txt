loadstring([[
-- ==============================================
-- Roblox防怪物抓取无敌脚本（终极修复版）
-- 核心：底层拦截抓取/处决事件+全场景防空值
-- 适配：Doors/内容警告/逃生试炼等含抓取机制的游戏
-- ==============================================
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

-- 全局状态（极简防空值，避免模块空引用）
local GlobalState = {
    LastDeathPosition = nil,
    IsBeingGrabbed = false,
    CurrentChar = nil,
    CurrentHum = nil,
    CurrentHRP = nil,
    -- 新增：应对不同怪物的控制状态标记
    IsInExec = false, -- 处决状态（如逃生试炼BOSS）
    IsStunned = false -- 击晕状态（如内容警告吸盘）
}

-- ===================== 核心工具函数（防失效增强） =====================
-- 工具1：安全获取组件（支持重试+超时）
local function SafeGetComponent(parent, compName, timeout)
    timeout = timeout or 10
    local start = tick()
    while tick() - start < timeout do
        local comp = parent:FindFirstChild(compName)
        if comp then return comp end
        task.wait(0.1)
    end
    warn("[Tool] 获取组件超时：" .. compName)
    return nil
end

-- 工具2：检查角色有效性（适配怪物抓取后的异常状态）
local function IsCharValid()
    local char = GlobalState.CurrentChar
    if not char or not char:IsDescendantOf(Workspace) then return false end
    local hum = GlobalState.CurrentHum
    local hrp = GlobalState.CurrentHRP
    -- 新增：排除抓取/处决/击晕等异常状态
    return hum and hrp and hum.Health ~= nil and not GlobalState.IsBeingGrabbed and not GlobalState.IsInExec
end

-- 工具3：重置角色状态（应对抓取后残留问题）
local function ResetCharState()
    GlobalState.IsBeingGrabbed = false
    GlobalState.IsInExec = false
    GlobalState.IsStunned = false
    print("[Tool] 角色状态已重置")
end

-- ===================== 角色初始化（防抓取核心） =====================
local function InitCharacter()
    -- 安全获取角色（应对重生/切换）
    local char = LocalPlayer.Character
    if not char then
        print("[CharInit] 等待角色生成...")
        char = LocalPlayer.CharacterAdded:Wait()
        task.wait(1.5) -- 手机端适配：延长重生加载延迟
    end
    GlobalState.CurrentChar = char

    -- 强制获取核心组件（避免空值）
    local hum = SafeGetComponent(char, "Humanoid", 15)
    local hrp = SafeGetComponent(char, "HumanoidRootPart", 15)
    if not hum or not hrp then
        warn("[CharInit] 组件加载失败，重试初始化")
        task.wait(1)
        InitCharacter()
        return
    end
    GlobalState.CurrentHum = hum
    GlobalState.CurrentHRP = hrp
    print("[CharInit] 角色组件初始化完成")

    -- 1. 拦截人形状态变化（覆盖所有怪物控制）
    hum.StateChanged:Connect(function(_, newState)
        -- 识别怪物抓取（Ragdoll）、击晕（Stunned）、倒地（FallingDown）
        if newState == Enum.HumanoidStateType.Ragdoll then
            GlobalState.IsBeingGrabbed = true
            print("[State] 检测到怪物抓取（如蜈蚣/水熊虫）")
        elseif newState == Enum.HumanoidStateType.FallingDown then
            GlobalState.IsStunned = true
            print("[State] 检测到击晕（如吸盘/圆石）")
        elseif newState == Enum.HumanoidStateType.Dead then
            GlobalState.IsInExec = true
            print("[State] 检测到处决（如BOSS/精英怪）")
        else
            ResetCharState() -- 正常状态时重置标记
        end
    end)

    -- 2. 底层拦截死亡事件（优先于游戏机制）
    hum.Died:Connect(function()
        print("[Death] 检测到死亡事件，强制拦截")
        -- 强制恢复状态（防怪物处决）
        hum.Health = hum.MaxHealth
        hum.BreakJointsOnDeath = false
        -- 传送至死亡前位置（防抓取后位置偏移）
        if GlobalState.LastDeathPosition then
            hrp.CFrame = CFrame.new(GlobalState.LastDeathPosition + Vector3.new(0, 3, 0))
        end
        -- 重置异常状态
        ResetCharState()
        hum:ChangeState(Enum.HumanoidStateType.Running)
    end)
end

-- ===================== 位置记录（精准复活基础） =====================
local function StartPosRecorder()
    RunService.Heartbeat:Connect(function()
        if not IsCharValid() then return end
        local hum = GlobalState.CurrentHum
        local hrp = GlobalState.CurrentHRP
        -- 仅在存活时更新位置（避免抓取后记录错误位置）
        if hum.Health > 0 then
            GlobalState.LastDeathPosition = hrp.Position
            -- 每8秒输出日志，确认功能生效
            if math.floor(tick() % 8) == 0 then
                print("[PosRecorder] 当前安全位置：" .. tostring(GlobalState.LastDeathPosition))
            end
        end
    end)
end

-- ===================== 无敌+防抓取逻辑（全场景覆盖） =====================
local function StartGodMode()
    RunService.Heartbeat:Connect(function()
        if not IsCharValid() then return end
        local hum = GlobalState.CurrentHum
        local hrp = GlobalState.CurrentHRP

        -- 1. 强制禁用死亡/控制机制（防游戏覆盖）
        hum.BreakJointsOnDeath = false
        hum:SetStateEnabled(Enum.HumanoidStateType.Dead, false)
        hum:SetStateEnabled(Enum.HumanoidStateType.Ragdoll, false)
        hum:SetStateEnabled(Enum.HumanoidStateType.FallingDown, false)

        -- 2. 抓取/处决/击晕时强制回血（覆盖所有怪物控制）
        if GlobalState.IsBeingGrabbed or GlobalState.IsInExec or GlobalState.IsStunned then
            hum.Health = hum.MaxHealth
            ResetCharState()
            -- 强制解除控制（如被吸盘吊起、蜈蚣抓取）
            hrp.CFrame = hrp.CFrame + Vector3.new(0, 1, 0) -- 轻微上移防卡模型
            hum:ChangeState(Enum.HumanoidStateType.Running)
            print("[GodMode] 已解除怪物控制，恢复满血量")
        end

        -- 3. 实时维持满血量（防秒杀/持续伤害）
        if hum.Health < hum.MaxHealth then
            hum.Health = hum.MaxHealth
        end
    end)
end

-- ===================== 角色重生适配（防切换失效） =====================
local function BindCharRespawn()
    LocalPlayer.CharacterAdded:Connect(function()
        print("[Respawn] 检测到角色重生，重新初始化")
        -- 清理残留状态
        ResetCharState()
        -- 延迟初始化（适配手机端重生节奏）
        task.wait(2)
        InitCharacter()
        print("[Respawn] 重生后功能重新绑定完成")
    end)
end

-- ===================== 手机端提示（状态可视化） =====================
local function ShowMobileHint()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "AntiGrabHint"
    ScreenGui.Parent = game:GetService("CoreGui")
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    local Frame = Instance.new("Frame")
    Frame.Size = UDim2.new(0.9, 0, 0.35, 0)
    Frame.Position = UDim2.new(0.05, 0, 0.55, 0)
    Frame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    Frame.BackgroundTransparency = 0.2
    Frame.BorderSizePixel = 0
    Frame.Parent = ScreenGui

    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 12)
    UICorner.Parent = Frame

    local Text = Instance.new("TextLabel")
    Text.Size = UDim2.new(1, 0, 1, 0)
    Text.BackgroundTransparency = 1
    Text.Text = "✅ 防怪物抓取脚本启动\n支持：抓取/处决/击晕拦截\n功能：强制无敌+精准复活\n控制台可查看状态日志"
    Text.TextColor3 = Color3.fromRGB(255, 255, 255)
    Text.TextScaled = true
    Text.Font = Enum.Font.Gotham
    Text.TextStrokeTransparency = 0.8
    Text.Parent = Frame

    -- 10秒后渐变隐藏（防遮挡操作）
    task.wait(10)
    for i = 1, 20 do
        Frame.BackgroundTransparency += 0.04
        Text.TextTransparency += 0.05
        task.wait(0.1)
    end
    ScreenGui:Destroy()
end

-- ===================== 安全启动（防初始化失败） =====================
local function SafeStart()
    local success, err = pcall(function()
        InitCharacter()
        StartPosRecorder()
        StartGodMode()
        BindCharRespawn()
        ShowMobileHint()
    end)
    if not success then
        warn("[Start] 首次启动失败，重试：" .. err)
        task.wait(2)
        SafeStart()
    else
        print("[Start] 脚本启动完成 | 防怪物抓取功能已生效")
    end
end

-- 执行启动
SafeStart()
]])()

loadstring([[
-- ==============================================
-- 防怪物抓取死亡+精准复活脚本（修复状态枚举报错）
-- 核心修复：移除无效的Stunned状态枚举
-- ==============================================
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

local GlobalState = {
    GodModeEnabled = true,
    AutoRespawnEnabled = true,
    LastSafePosition = nil,
    LastDeathPosition = nil,
    IsScriptRunning = true,
    ActiveConnections = {},
    IsBeingGrabbed = false
}

local function SafeWaitForChild(parent, childName, maxRetry, retryInterval)
    maxRetry = maxRetry or 30
    retryInterval = retryInterval or 0.2
    local retryCount = 0
    while retryCount < maxRetry do
        local target = parent:FindFirstChild(childName)
        if target then
            print("[Tool] 成功加载对象：" .. childName)
            return target
        end
        retryCount = retryCount + 1
        task.wait(retryInterval)
    end
    warn("[Tool] 等待对象超时：" .. childName .. "，重试获取")
    task.wait(1.5)
    return parent:FindFirstChild(childName)
end

local function IsCharacterValid(character)
    if not character or not character:IsDescendantOf(Workspace) then return false end
    local humanoid = character:FindFirstChild("Humanoid")
    local hrp = character:FindFirstChild("HumanoidRootPart")
    return humanoid and hrp and humanoid.Health ~= nil and humanoid.MaxHealth ~= nil and not GlobalState.IsBeingGrabbed
end

local function ClearOldConnections()
    for _, conn in ipairs(GlobalState.ActiveConnections) do
        if conn and typeof(conn) == "RBXScriptConnection" then
            conn:Disconnect()
        end
    end
    GlobalState.ActiveConnections = {}
end

local CharacterManager = {
    UpdateComponents = function()
        local character = LocalPlayer.Character
        if not character then
            print("[CharacterManager] 等待角色生成...")
            local charWaitConn = LocalPlayer.CharacterAdded:Wait()
            character = charWaitConn
            task.wait(1.8)
        end
        local humanoid = SafeWaitForChild(character, "Humanoid", 30, 0.1)
        local hrp = SafeWaitForChild(character, "HumanoidRootPart", 30, 0.1)
        
        if not humanoid or not hrp then
            task.wait(1)
            humanoid = SafeWaitForChild(character, "Humanoid", 25, 0.1)
            hrp = SafeWaitForChild(character, "HumanoidRootPart", 25, 0.1)
        end
        
        GlobalState.CharacterComponents = {
            Character = character,
            Humanoid = humanoid,
            HumanoidRootPart = hrp
        }
        print("[CharacterManager] 角色组件更新完成")
        
        humanoid.StateChanged:Connect(function(oldState, newState)
            if newState == Enum.HumanoidStateType.Ragdoll or newState == Enum.HumanoidStateType.FallingDown then
                GlobalState.IsBeingGrabbed = true
                print("[CharacterManager] 检测到怪物抓取，标记抓取状态")
            else
                GlobalState.IsBeingGrabbed = false
            end
        end)
        
        return character, humanoid, hrp
    end,

    GetComponents = function()
        local char = GlobalState.CharacterComponents.Character
        if not IsCharacterValid(char) then
            return CharacterManager.UpdateComponents()
        end
        return GlobalState.CharacterComponents.Character,
               GlobalState.CharacterComponents.Humanoid,
               GlobalState.CharacterComponents.HumanoidRootPart
    end
}

local PositionRecorder = {
    StartRecording = function()
        print("[PositionRecorder] 位置记录模块已启动（含死亡锁定）")
        local conn = RunService.Heartbeat:Connect(function()
            if not GlobalState.IsScriptRunning then return end
            local _, humanoid, hrp = CharacterManager.GetComponents()
            if humanoid and hrp then
                if humanoid.Health > 0 then
                    GlobalState.LastSafePosition = hrp.Position
                end
                if humanoid.Health <= 0 and not GlobalState.IsBeingGrabbed then
                    GlobalState.LastDeathPosition = hrp.Position
                    print("[PositionRecorder] 死亡位置锁定：" .. tostring(GlobalState.LastDeathPosition))
                end
            end
        end)
        table.insert(GlobalState.ActiveConnections, conn)
    end
}

local GodModeModule = {
    StartGodMode = function()
        print("[GodModeModule] 无敌模块已启动（防抓取死亡）")
        local conn = RunService.Heartbeat:Connect(function()
            if not GlobalState.IsScriptRunning or not GlobalState.GodModeEnabled then return end
            local _, humanoid = CharacterManager.GetComponents()
            if humanoid then
                -- 移除无效的Stunned状态枚举
                humanoid.BreakJointsOnDeath = false
                humanoid:SetStateEnabled(Enum.HumanoidStateType.Dead, false)
                humanoid:SetStateEnabled(Enum.HumanoidStateType.Ragdoll, false)
                humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown, false)
                
                if humanoid.Health <= 0 or GlobalState.IsBeingGrabbed then
                    humanoid.Health = humanoid.MaxHealth
                    GlobalState.IsBeingGrabbed = false
                    print("[GodModeModule] 拦截强制死亡/抓取，恢复满血量")
                end
            end
        end)
        table.insert(GlobalState.ActiveConnections, conn)
    end
}

local AutoRespawnModule = {
    StartAutoRespawn = function()
        print("[AutoRespawnModule] 原地复活模块已启动（精准位置）")
        local conn = RunService.Heartbeat:Connect(function()
            if not GlobalState.IsScriptRunning or not GlobalState.AutoRespawnEnabled or not GlobalState.GodModeEnabled then return end
            local character, humanoid, hrp = CharacterManager.GetComponents()
            if humanoid and hrp and humanoid.Health <= 0 then
                local respawnPos = GlobalState.LastDeathPosition or GlobalState.LastSafePosition or Vector3.new(0, 3, 0)
                print("[AutoRespawnModule] 执行原地复活，位置：" .. tostring(respawnPos))
                
                humanoid.Health = humanoid.MaxHealth
                hrp.CFrame = CFrame.new(respawnPos + Vector3.new(0, 3, 0))
                humanoid:ChangeState(Enum.HumanoidStateType.Running)
                
                task.wait(0.5)
                CharacterManager.UpdateComponents()
                GlobalState.IsBeingGrabbed = false
            end
        end)
        table.insert(GlobalState.ActiveConnections, conn)
    end
}

local function BindCharacterChange()
    LocalPlayer.CharacterAdded:Connect(function(newChar)
        print("[System] 检测到角色切换/重生，重新初始化功能")
        ClearOldConnections()
        task.wait(2)
        CharacterManager.UpdateComponents()
        PositionRecorder.StartRecording()
        GodModeModule.StartGodMode()
        AutoRespawnModule.StartAutoRespawn()
        print("[System] 角色功能重新绑定完成（防抓取生效）")
    end)
end

local MobileHintModule = {
    ShowStartupHint = function()
        local ScreenGui = Instance.new("ScreenGui")
        ScreenGui.Name = "MobileScriptHint"
        ScreenGui.Parent = game:GetService("CoreGui")
        ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
        
        local Frame = Instance.new("Frame")
        Frame.Size = UDim2.new(0.9, 0, 0.35, 0)
        Frame.Position = UDim2.new(0.05, 0, 0.55, 0)
        Frame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
        Frame.BackgroundTransparency = 0.2
        Frame.BorderSizePixel = 0
        Frame.Parent = ScreenGui
        
        local UICorner = Instance.new("UICorner")
        UICorner.CornerRadius = UDim.new(0, 12)
        UICorner.Parent = Frame
        
        local UIGradient = Instance.new("UIGradient")
        UIGradient.Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.fromRGB(30, 30, 30)),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(10, 10, 10))
        })
        UIGradient.Parent = Frame
        
        local TextLabel = Instance.new("TextLabel")
        TextLabel.Size = UDim2.new(1, 0, 1, 0)
        TextLabel.BackgroundTransparency = 1
        TextLabel.Text = "✅ 防怪物抓取脚本启动\n功能：拦截死亡+精准复活\n已修复状态枚举报错"
        TextLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        TextLabel.TextScaled = true
        TextLabel.Font = Enum.Font.Gotham
        TextLabel.TextStrokeTransparency = 0.8
        TextLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
        TextLabel.Parent = Frame
        
        task.wait(10)
        for i = 1, 20 do
            Frame.BackgroundTransparency = Frame.BackgroundTransparency + 0.04
            TextLabel.TextTransparency = TextLabel.TextTransparency + 0.05
            task.wait(0.1)
        end
        ScreenGui:Destroy()
    end
}

local MainInitializer = {
    InitializeAll = function()
        print("[MainInitializer] 脚本初始化中（防怪物抓取版）")
        ClearOldConnections()
        CharacterManager.UpdateComponents()
        PositionRecorder.StartRecording()
        GodModeModule.StartGodMode()
        AutoRespawnModule.StartAutoRespawn()
        BindCharacterChange()
        MobileHintModule.ShowStartupHint()
        print("[MainInitializer] 脚本启动完成 | 已修复状态枚举报错")
    end
}

local function SafeStart()
    local success, err = pcall(function()
        MainInitializer.InitializeAll()
    end)
    if not success then
        warn("[System] 首次启动失败，重试中：" .. err)
        task.wait(2)
        MainInitializer.InitializeAll()
    end
end

SafeStart()
]])()

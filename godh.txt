loadstring([[
-- ==============================================
-- Roblox通用无敌+原地复活脚本（效果增强版）
-- 核心改进：解决功能不生效、角色切换失效问题
-- 适配：手机端执行器、全Roblox游戏
-- ==============================================
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

-- ===================== 全局状态管理（增强稳定性） =====================
local GlobalState = {
    GodModeEnabled = true,
    AutoRespawnEnabled = true,
    LastSafePosition = nil,
    IsScriptRunning = true,
    -- 新增：存储连接防止内存泄漏
    ActiveConnections = {},
    Version = "v2.4.0 (Fixed Inactive Issue)",
    Author = "Roblox Script Toolkit"
}

-- ===================== 核心工具函数（防失效增强） =====================
-- 工具1：安全等待对象加载（延长超时+重试提示）
local function SafeWaitForChild(parent, childName, maxRetry, retryInterval)
    maxRetry = maxRetry or 25 -- 延长超时（原15次→25次）
    retryInterval = retryInterval or 0.2
    local retryCount = 0
    while retryCount < maxRetry do
        local target = parent:FindFirstChild(childName)
        if target then
            print("[Tool] 成功加载对象：" .. childName)
            return target
        end
        retryCount = retryCount + 1
        task.wait(retryInterval)
    end
    warn("[Tool] 等待对象超时：" .. childName .. "，将尝试重新获取")
    -- 超时后二次重试（解决临时加载失败）
    task.wait(1)
    return parent:FindFirstChild(childName)
end

-- 工具2：检查角色有效性（增加组件状态判断）
local function IsCharacterValid(character)
    if not character or not character:IsDescendantOf(Workspace) then return false end
    local humanoid = character:FindFirstChild("Humanoid")
    local hrp = character:FindFirstChild("HumanoidRootPart")
    -- 新增：判断Humanoid是否正常（防失效）
    return humanoid and hrp and humanoid.Health ~= nil and humanoid.MaxHealth ~= nil
end

-- 工具3：清理旧连接（防止重复绑定导致失效）
local function ClearOldConnections()
    for _, conn in ipairs(GlobalState.ActiveConnections) do
        if conn and typeof(conn) == "RBXScriptConnection" then
            conn:Disconnect()
        end
    end
    GlobalState.ActiveConnections = {}
end

-- ===================== 角色组件管理（实时更新防失效） =====================
local CharacterManager = {
    -- 更新角色组件（增加重试逻辑）
    UpdateComponents = function()
        local character = LocalPlayer.Character
        if not character then
            print("[CharacterManager] 等待角色生成...")
            -- 新增：等待角色时增加超时重试
            local charWaitConn = LocalPlayer.CharacterAdded:Wait()
            character = charWaitConn
            task.wait(1.2) -- 延长手机端加载延迟（原0.7→1.2秒）
        end
        -- 安全获取核心组件
        local humanoid = SafeWaitForChild(character, "Humanoid", 25, 0.1)
        local hrp = SafeWaitForChild(character, "HumanoidRootPart", 25, 0.1)
        -- 组件无效时重试
        if not humanoid or not hrp then
            task.wait(0.5)
            humanoid = SafeWaitForChild(character, "Humanoid", 20, 0.1)
            hrp = SafeWaitForChild(character, "HumanoidRootPart", 20, 0.1)
        end
        -- 存储有效组件
        GlobalState.CharacterComponents = {
            Character = character,
            Humanoid = humanoid,
            HumanoidRootPart = hrp
        }
        print("[CharacterManager] 角色组件更新完成")
        return character, humanoid, hrp
    end,

    -- 获取当前组件（实时校验）
    GetComponents = function()
        local char = GlobalState.CharacterComponents.Character
        -- 组件失效时重新加载
        if not IsCharacterValid(char) then
            return CharacterManager.UpdateComponents()
        end
        return GlobalState.CharacterComponents.Character,
               GlobalState.CharacterComponents.Humanoid,
               GlobalState.CharacterComponents.HumanoidRootPart
    end
}

-- ===================== 位置记录模块（防丢失增强） =====================
local PositionRecorder = {
    StartRecording = function()
        print("[PositionRecorder] 位置记录模块已启动")
        -- 存储连接防止丢失
        local conn = RunService.Heartbeat:Connect(function()
            if not GlobalState.IsScriptRunning then return end
            local _, humanoid, hrp = CharacterManager.GetComponents()
            if humanoid and hrp and humanoid.Health > 0 then
                GlobalState.LastSafePosition = hrp.Position
                -- 新增：位置更新提示（确认功能生效）
                if math.floor(tick() % 8) == 0 then
                    print("[PositionRecorder] 当前安全位置：" .. tostring(GlobalState.LastSafePosition))
                end
            end
        end)
        table.insert(GlobalState.ActiveConnections, conn)
    end
}

-- ===================== 无敌功能模块（防拦截增强） =====================
local GodModeModule = {
    StartGodMode = function()
        print("[GodModeModule] 无敌模块已启动")
        -- 存储连接防止丢失
        local conn = RunService.Heartbeat:Connect(function()
            if not GlobalState.IsScriptRunning or not GlobalState.GodModeEnabled then return end
            local _, humanoid = CharacterManager.GetComponents()
            if humanoid then
                -- 强制禁用死亡机制（防游戏覆盖设置）
                humanoid.BreakJointsOnDeath = false
                humanoid:SetStateEnabled(Enum.HumanoidStateType.Dead, false)
                humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown, false)
                -- 强制维持满血量（防拦截）
                if humanoid.Health > 0 then
                    humanoid.Health = humanoid.MaxHealth
                    -- 新增：血量恢复提示（确认功能生效）
                    if math.floor(tick() % 10) == 0 then
                        print("[GodModeModule] 已维持满血量")
                    end
                end
            end
        end)
        table.insert(GlobalState.ActiveConnections, conn)
    end
}

-- ===================== 原地复活模块（防失效增强） =====================
local AutoRespawnModule = {
    StartAutoRespawn = function()
        print("[AutoRespawnModule] 原地复活模块已启动")
        -- 存储连接防止丢失
        local conn = RunService.Heartbeat:Connect(function()
            if not GlobalState.IsScriptRunning or not GlobalState.AutoRespawnEnabled or not GlobalState.GodModeEnabled then return end
            local character, humanoid, hrp = CharacterManager.GetComponents()
            if humanoid and hrp and humanoid.Health <= 0 and GlobalState.LastSafePosition then
                print("[AutoRespawnModule] 检测到死亡，执行原地复活")
                -- 强制恢复状态（防游戏拦截）
                humanoid.Health = humanoid.MaxHealth
                humanoid:ChangeState(Enum.HumanoidStateType.Running)
                -- 精准传送（增加高度偏移防卡地）
                hrp.CFrame = CFrame.new(GlobalState.LastSafePosition + Vector3.new(0, 2.5, 0))
                -- 新增：复活后重新绑定组件（防止后续失效）
                task.wait(0.3)
                CharacterManager.UpdateComponents()
            end
        end)
        table.insert(GlobalState.ActiveConnections, conn)
    end
}

-- ===================== 角色切换适配（防失效核心） =====================
local function BindCharacterChange()
    -- 角色生成时重新初始化
    LocalPlayer.CharacterAdded:Connect(function(newChar)
        print("[System] 检测到角色切换，重新初始化功能")
        -- 清理旧连接（防止冲突）
        ClearOldConnections()
        -- 延迟加载新角色（适配手机端节奏）
        task.wait(1.5)
        -- 重新更新组件+启动所有功能
        CharacterManager.UpdateComponents()
        PositionRecorder.StartRecording()
        GodModeModule.StartGodMode()
        AutoRespawnModule.StartAutoRespawn()
        print("[System] 角色切换后功能重新绑定完成")
    end)
end

-- ===================== 手机端提示模块（功能状态可视化） =====================
local MobileHintModule = {
    ShowStartupHint = function()
        local ScreenGui = Instance.new("ScreenGui")
        ScreenGui.Name = "MobileScriptHint"
        ScreenGui.Parent = game:GetService("CoreGui")
        ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
        
        -- 提示框框架
        local Frame = Instance.new("Frame")
        Frame.Size = UDim2.new(0.85, 0, 0.3, 0)
        Frame.Position = UDim2.new(0.075, 0, 0.6, 0)
        Frame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
        Frame.BackgroundTransparency = 0.2
        Frame.BorderSizePixel = 0
        Frame.Parent = ScreenGui
        
        -- 圆角+渐变装饰
        local UICorner = Instance.new("UICorner")
        UICorner.CornerRadius = UDim.new(0, 12)
        UICorner.Parent = Frame
        
        local UIGradient = Instance.new("UIGradient")
        UIGradient.Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.fromRGB(30, 30, 30)),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(10, 10, 10))
        })
        UIGradient.Parent = Frame
        
        -- 提示文字（显示功能状态）
        local TextLabel = Instance.new("TextLabel")
        TextLabel.Size = UDim2.new(1, 0, 1, 0)
        TextLabel.BackgroundTransparency = 1
        TextLabel.Text = "✅ 脚本已启动（增强版）\n功能：无敌+原地复活\n版本：" .. GlobalState.Version .. "\n控制台可查看功能日志"
        TextLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        TextLabel.TextScaled = true
        TextLabel.Font = Enum.Font.Gotham
        TextLabel.TextStrokeTransparency = 0.8
        TextLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
        TextLabel.Parent = Frame
        
        -- 8秒后自动隐藏（延长显示时间，方便确认）
        task.wait(8)
        for i = 1, 15 do
            Frame.BackgroundTransparency = Frame.BackgroundTransparency + 0.05
            TextLabel.TextTransparency = TextLabel.TextTransparency + 0.06
            task.wait(0.1)
        end
        ScreenGui:Destroy()
    end
}

-- ===================== 主初始化模块（防失效启动） =====================
local MainInitializer = {
    InitializeAll = function()
        print("[MainInitializer] 脚本初始化中（增强版）")
        -- 清理旧连接（防止残留冲突）
        ClearOldConnections()
        -- 初始化角色组件（确保加载完成）
        CharacterManager.UpdateComponents()
        -- 启动核心功能
        PositionRecorder.StartRecording()
        GodModeModule.StartGodMode()
        AutoRespawnModule.StartAutoRespawn()
        -- 绑定角色切换适配（防失效关键）
        BindCharacterChange()
        -- 显示手机端提示
        MobileHintModule.ShowStartupHint()
        -- 启动日志（确认功能状态）
        print("[MainInitializer] 脚本启动完成 | 版本：" .. GlobalState.Version)
        print("[MainInitializer] 功能状态：无敌=" .. tostring(GlobalState.GodModeEnabled) .. " | 自动复活=" .. tostring(GlobalState.AutoRespawnEnabled))
    end
}

-- ===================== 执行主初始化（防启动失败） =====================
-- 新增：启动重试逻辑
local function SafeStart()
    local success, err = pcall(function()
        MainInitializer.InitializeAll()
    end)
    if not success then
        warn("[System] 首次启动失败，重试中：" .. err)
        task.wait(1)
        MainInitializer.InitializeAll()
    end
end

SafeStart()
]])()

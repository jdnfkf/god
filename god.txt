--[[ 
    PHOENIX_SUPREME_V25_OMNI_SERVER
    AUTHORITY: NETWORK_OWNERSHIP_OVERRIDE & SERVER_RECONSTRUCTION
    MEMORY_SAFE: ACTIVE (ASYNC_LATTICE_V5)
]]

-- [[ 1. 核心模块初始化 (Workspace 物理挂钩) ]]
local function BuildV25Core()
    local Root = workspace:FindFirstChild("Phoenix_V25_Authority") or Instance.new("Folder", workspace)
    Root.Name = "Phoenix_V25_Authority"
    
    local Heart = Root:FindFirstChild("Auth_Heart") or Instance.new("Part", Root)
    Heart.Name = "Auth_Heart"
    Heart.Anchored, Heart.Transparency, Heart.CanCollide = true, 1, false
    Heart.CFrame = CFrame.new(0, 100000, 0)
    
    return Heart
end
local HeartNode = BuildV25Core()

-- 基础变量定义
local LP = game:GetService("Players").LocalPlayer
local RS = game:GetService("RunService")
local SafeCF = nil
local Protocol_Lock = false

-- [[ 2. 核心增强：网络拥有权抢占 (Network Ownership Override) ]]
-- 该模块强制服务器将附近零件的物理计算权交给你，实现对物理障碍/怪物的“降维打击”
local function OverrideNetworkOwnership()
    task.spawn(function()
        while true do
            task.wait(1) -- 每秒同步一次，平衡性能与权限
            pcall(function()
                local char = LP.Character
                if char and char:FindFirstChild("HumanoidRootPart") then
                    local pos = char.HumanoidRootPart.Position
                    for _, v in pairs(workspace:GetDescendants()) do
                        if v:IsA("BasePart") and not v.Anchored and (v.Position - pos).Magnitude < 50 then
                            -- 强制设置网络拥有权（仅在部分支持的游戏中生效，用于物理推开怪物）
                            setnetworkowner(v, LP) 
                        end
                    end
                end
            end)
        end
    end)
end

-- [[ 3. 终极功能：服务端强制角色重构 (强制复活) ]]
local function EnforceServerRebirth()
    if Protocol_Lock then return end
    Protocol_Lock = true
    
    pcall(function()
        local char = LP.Character
        if char and char:FindFirstChild("HumanoidRootPart") then
            SafeCF = char.HumanoidRootPart.CFrame
        end
        warn(">>> [SERVER_SYNC] 正在执行服务端强制重构协议...")
        LP:LoadCharacter() -- 强制重载实体
    end)
    
    task.delay(4, function() Protocol_Lock = false end) -- 防卡死冷却
end

-- [[ 4. 底层协议拦截 (上帝模式 / 抓取拦截 / 镜头锁定) ]]
local mt = getrawmetatable(game)
local old_nc = mt.__namecall
local old_idx = mt.__index
setreadonly(mt, false)

mt.__namecall = newcclosure(function(self, ...)
    local method = getnamecallmethod()
    
    -- 拦截服务端物理销毁
    if (method == "Destroy" or method == "BreakJoints") and (self == LP.Character or self:IsDescendantOf(LP.Character)) then
        return nil 
    end
    
    -- 拦截死亡心跳回传 (伪造生存状态)
    if method == "FireServer" or method == "InvokeServer" then
        local rName = tostring(self):lower()
        if rName:find("death") or rName:find("died") or rName:find("damage") then
            return nil 
        end
    end
    
    return old_nc(self, ...)
end)

mt.__index = newcclosure(function(t, k)
    -- 上帝模式属性伪装
    if t:IsA("Humanoid") and k == "Health" then return 100 end
    -- 相机权限抢占 (防止剧情杀锁视角)
    if t:IsA("Camera") and (k == "CameraType" or k == "CFrame") then
        return old_idx(t, k)
    end
    return old_idx(t, k)
end)
setreadonly(mt, true)

-- [[ 5. 守护进程：9倍回血 / 坐标锚点 / 复活判定 ]]
RS.Heartbeat:Connect(function(dt)
    if Protocol_Lock then return end
    
    pcall(function()
        local char = LP.Character
        local hum = char and char:FindFirstChildOfClass("Humanoid")
        local hrp = char and char:FindFirstChild("HumanoidRootPart")

        if hum and hrp and hum.Health > 0 then
            -- 9倍极速回血
            hum.Health = math.min(hum.MaxHealth, hum.Health + (9 * dt))
            hum:SetStateEnabled(Enum.HumanoidStateType.Dead, false)
            
            -- 坐标锚点 (防止剧情传送/强制掉落)
            if not SafeCF then SafeCF = hrp.CFrame end
            if (hrp.Position - SafeCF.Position).Magnitude > 60 then
                hrp.CFrame = SafeCF
            else
                SafeCF = hrp.CFrame
            end
        end

        -- 复活逻辑判定
        if (not char or not char.Parent) or (hum and hum.Health <= 0) then
            EnforceServerRebirth()
        end
    end)
end)

-- [[ 6. 资产清洗 (拦截抓取 / 突脸杀 / 死亡 UI) ]]
workspace.DescendantAdded:Connect(function(v)
    task.spawn(function()
        local n = v.Name:lower()
        if n:find("kill") or n:find("scare") or n:find("grab") or n:find("jumpscare") then
            task.wait(0.2)
            pcall(function() v:Destroy() end)
        end
    end)
end)

task.spawn(function()
    while true do
        task.wait(1.5)
        pcall(function()
            for _, g in pairs(LP.PlayerGui:GetChildren()) do
                local gn = g.Name:lower()
                if gn:find("death") or gn:find("spectate") or gn:find("died") then
                    g:Destroy()
                end
            end
        end)
    end
end)

-- 角色重构后的坐标对齐
LP.CharacterAdded:Connect(function(nc)
    local hrp = nc:WaitForChild("HumanoidRootPart", 5)
    if hrp and SafeCF then
        task.wait(0.2)
        hrp.CFrame = SafeCF
    end
end)

-- 启动网络拥有权模块
OverrideNetworkOwnership()

print(">>> [PHOENIX V25] 终极全能服务端版已启动。已增强物理拥有权权限。")
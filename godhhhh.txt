--[[
    UNIVERSAL SURVIVAL KERNEL - ELITE BYPASS EDITION
    TARGET: ALL GAMES (ANTI-PERMADEATH / ANTI-SPECTATE)
    COMPATIBILITY: LUA 5.1 / PROMETHEUS READY
]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- 全局核心配置
local X9_ELITE = {
    P = nil, -- 死亡坐标锚点
    M = 9,   -- 9倍回血
    K = true -- 系统开关
}

-- 安全执行函数，防止混淆后报错
local function SafeInvoke(f, ...)
    local a = {...}
    return xpcall(function() return f(unpack(a)) end, function() end)
end

-- 1. 内核级劫持：欺骗游戏逻辑，拦截死亡与观战
local function ActivateEliteHook()
    local mt = getrawmetatable(game)
    local old_nc = mt.__namecall
    local old_idx = mt.__index
    if setreadonly then setreadonly(mt, false) end
    
    -- 劫持索引：当脚本检测你是否死亡时，强行返回“存活”
    mt.__index = newcclosure(function(t, k)
        if t:IsA("Humanoid") and (k == "Health" or k == "health") then
            return 100 -- 始终伪装满血
        end
        return old_idx(t, k)
    end)

    mt.__namecall = newcclosure(function(self, ...)
        local method = getnamecallmethod()
        
        -- 核心：拦截剧情杀/销毁/一命限制指令
        if (method == "BreakJoints" or method == "Destroy") and self:IsDescendantOf(LocalPlayer.Character or game) then
            return nil 
        end
        
        -- 核心：屏蔽观战切换远程指令
        if method == "FireServer" then
            local n = tostring(self):lower()
            if n:find("spectate") or n:find("team") or n:find("requestrespawn") then
                -- 某些游戏需要返回特定的伪装参数，此处直接放行但拦截恶意销毁
            end
        end
        
        return old_nc(self, ...)
    end)
    
    if setreadonly then setreadonly(mt, true) end
end

-- 2. 强制重生与观战 UI 破解
local function BypassSystem()
    -- 实时锁定最后存活位置
    RunService.Stepped:Connect(function()
        SafeInvoke(function()
            local c = LocalPlayer.Character
            if c and c:FindFirstChild("HumanoidRootPart") and c.Humanoid.Health > 1 then
                X9_ELITE.P = c.HumanoidRootPart.CFrame
            end
        end)
    end)

    -- 强制破解观战界面
    LocalPlayer.PlayerGui.ChildAdded:Connect(function(ui)
        local n = ui.Name:lower()
        -- 针对不同游戏的观战、结算、死亡提示进行暴力拆除
        if n:find("spectate") or n:find("death") or n:find("dead") or n:find("menu") or n:find("gameover") then
            task.wait()
            ui:Destroy()
            -- 强制重载角色以跳过“一命”限制
            if not LocalPlayer.Character or not LocalPlayer.Character.Parent then
                LocalPlayer:LoadCharacter()
            end
        end
    end)
end

-- 3. 9倍生存动力学 (修复报错版)
local function InjectProtection(char)
    if not char then return end
    task.defer(function()
        local h = char:WaitForChild("Humanoid", 20)
        local r = char:WaitForChild("HumanoidRootPart", 20)
        if not h or not r then return end
        
        -- 核心增强：强制锁定状态机为非死亡
        h:SetStateEnabled(Enum.HumanoidStateType.Dead, false)
        
        local loop
        loop = RunService.Heartbeat:Connect(function()
            if not char.Parent then loop:Disconnect() return end
            SafeInvoke(function()
                -- 9倍极速回血
                if h.Health < h.MaxHealth then
                    h.Health = math.min(h.Health + (h.MaxHealth * 0.012 * X9_ELITE.M), h.MaxHealth)
                end
                -- 防死亡位移与拉拽
                if r.Velocity.Magnitude > 300 then
                    r.Velocity = Vector3.new(0, 0, 0)
                    if X9_ELITE.P then r.CFrame = X9_ELITE.P end
                end
            end)
        end)
    end)
end

-- 启动主内核
SafeInvoke(ActivateEliteHook)
SafeInvoke(BypassSystem)
LocalPlayer.CharacterAdded:Connect(function(nc)
    SafeInvoke(function()
        local r = nc:WaitForChild("HumanoidRootPart", 25)
        if r and X9_ELITE.P then
            task.wait(0.1) -- 手机端抗同步延迟
            r.CFrame = X9_ELITE.P
        end
        InjectProtection(nc)
    end)
end)

if LocalPlayer.Character then InjectProtection(LocalPlayer.Character) end

print(">>> [SECURITY_SUCCESS] 万能观战/一命破解模块已加载")
loadstring([[
-- å…¨å±€æœåŠ¡åˆå§‹åŒ–ï¼ˆå…¼å®¹æ‰€æœ‰Robloxæ¸¸æˆï¼Œæ‰‹æœºç«¯é€‚é…ä¼˜åŒ–ï¼‰
local player = game:GetService("Players").LocalPlayer
local RUN_SERVICE = game:GetService("RunService")
local WORKSPACE = game:GetService("Workspace")
local REPLICATED_STORAGE = game:GetService("ReplicatedStorage")
local PLAYER_SERVICE = game:GetService("Players")
local DEBRIS = game:GetService("Debris")
local SCRIPT_CONTEXT = game:GetService("ScriptContext")
local USER_INPUT_SERVICE = game:GetService("UserInputService")
local HTTP_SERVICE = game:GetService("HttpService")

-- æ ¸å¿ƒé…ç½®å‚æ•°ï¼ˆé€šç”¨é€‚é…ï¼Œæ”¯æŒå¾®è°ƒï¼‰
local GLOBAL_CONFIG = {
    HEAL_MULTIPLIER = 9, -- 9å€è‡ªåŠ¨å›è¡€é€Ÿåº¦
    RESPAWN_DELAY = 0.03, -- æé€Ÿé‡ç”Ÿå»¶è¿Ÿï¼ˆæ‰‹æœºç«¯æ— å¡é¡¿ï¼‰
    MAX_HEAL_CAP = math.huge, -- å›è¡€æ— ä¸Šé™
    BLOCK_GRAB_RANGE = 25, -- æŠ“å–æ‹¦æˆªæ£€æµ‹èŒƒå›´ï¼ˆæ‰©å¤§é€‚é…å¤šæ¸¸æˆï¼‰
    ANTI_WARP_THRESHOLD = 10, -- çªè„¸æ‹¦æˆªè·ç¦»é˜ˆå€¼
    ANTI_SCRIPTED_DEATH_PRIORITY = 200, -- å‰§æƒ…æ€æ‹¦æˆªä¼˜å…ˆçº§ï¼ˆæœ€é«˜çº§ï¼‰
    ANTI_DESTROY_INTERVAL = 0.01, -- è§’è‰²é˜²é”€æ¯æ£€æµ‹é¢‘ç‡
    REMOTE_BLOCK_KEYWORDS = {"Kill", "Death", "Destroy", "Explode", "Execute", "ForceKill", "ScriptedDeath", "StoryKill", "OneShot", "Instakill", "RemoteKill", "AdminKill"}, -- è¿œç¨‹æ­»äº¡æŒ‡ä»¤å…³é”®è¯åº“
    SAFE_POS_OFFSET = Vector3.new(0, 0.8, 0) -- å¤æ´»ä½ç½®æŠ¬é«˜ï¼ˆé˜²å¡åœ°å½¢ï¼‰
}

-- å…¨å±€çŠ¶æ€ç®¡ç†ï¼ˆæŒä¹…åŒ–å­˜å‚¨å…³é”®æ•°æ®ï¼‰
local GLOBAL_STATE = {
    LastDeathCFrame = nil, -- æœ€åæ­»äº¡ä½ç½®ï¼ˆç²¾å‡†è®°å½•ï¼‰
    CharacterReference = nil, -- å½“å‰è§’è‰²æ¨¡å‹å¼•ç”¨
    HumanoidReference = nil, -- å½“å‰äººå½¢å¯¹è±¡å¼•ç”¨
    IsCharacterValid = false, -- è§’è‰²æœ‰æ•ˆæ€§æ ‡è®°
    RespawnLock = false, -- é‡ç”Ÿé”ï¼ˆé˜²æ­¢é‡å¤è§¦å‘ï¼‰
    ConnectionPool = { -- æ‰€æœ‰äº‹ä»¶è¿æ¥æ± ï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰
        HealConnection = nil,
        AntiGrabConnections = {},
        AntiWarpConnection = nil,
        AntiScriptedDeathConnections = {},
        AntiDestroyConnection = nil,
        RemoteBlockConnections = {},
        CharacterMonitorConnection = nil
    },
    BlockedRemoteEvents = {}, -- å·²æ‹¦æˆªçš„è¿œç¨‹äº‹ä»¶ç¼“å­˜
    BlockedRemoteFunctions = {}, -- å·²æ‹¦æˆªçš„è¿œç¨‹å‡½æ•°ç¼“å­˜
    LastValidHealth = 100 -- æœ€åæœ‰æ•ˆç”Ÿå‘½å€¼ï¼ˆé˜²ç¬é—´ç§’æ€ï¼‰
}

-- ==================== é€šç”¨å·¥å…·å‡½æ•°åº“ï¼ˆå¢å¼ºè„šæœ¬é€šç”¨æ€§ï¼‰====================
-- å®‰å…¨è·å–å®ä¾‹ï¼ˆå…¼å®¹å»¶è¿ŸåŠ è½½ï¼Œé˜²æ­¢nilæŠ¥é”™ï¼‰
local function SafeGetInstance(parent, name, className, timeout)
    timeout = timeout or 15 -- é»˜è®¤15ç§’è¶…æ—¶
    if not parent then return nil end
    local instance = parent:FindFirstChild(name)
    if instance and instance:IsA(className) then return instance end
    -- ç­‰å¾…å®ä¾‹åŠ è½½
    local start = tick()
    repeat
        wait(0.01)
        instance = parent:FindFirstChild(name)
        if instance and instance:IsA(className) then return instance end
    until tick() - start > timeout
    warn("SafeGetInstance: è¶…æ—¶æœªæ‰¾åˆ°å®ä¾‹ - çˆ¶å¯¹è±¡:", parent.Name, " ç›®æ ‡:", name, " ç±»å‹:", className)
    return nil
end

-- å¼ºåˆ¶æ–­å¼€æ‰€æœ‰è¿æ¥ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
local function DisconnectAllConnections()
    -- æ–­å¼€å›è¡€è¿æ¥
    if GLOBAL_STATE.ConnectionPool.HealConnection then
        pcall(function() GLOBAL_STATE.ConnectionPool.HealConnection:Disconnect() end)
        GLOBAL_STATE.ConnectionPool.HealConnection = nil
    end
    -- æ–­å¼€æŠ“å–æ‹¦æˆªè¿æ¥
    for _, conn in ipairs(GLOBAL_STATE.ConnectionPool.AntiGrabConnections) do
        if conn then pcall(function() conn:Disconnect() end) end
    end
    GLOBAL_STATE.ConnectionPool.AntiGrabConnections = {}
    -- æ–­å¼€çªè„¸æ‹¦æˆªè¿æ¥
    if GLOBAL_STATE.ConnectionPool.AntiWarpConnection then
        pcall(function() GLOBAL_STATE.ConnectionPool.AntiWarpConnection:Disconnect() end)
        GLOBAL_STATE.ConnectionPool.AntiWarpConnection = nil
    end
    -- æ–­å¼€å‰§æƒ…æ€æ‹¦æˆªè¿æ¥
    for _, conn in ipairs(GLOBAL_STATE.ConnectionPool.AntiScriptedDeathConnections) do
        if conn then pcall(function() conn:Disconnect() end) end
    end
    GLOBAL_STATE.ConnectionPool.AntiScriptedDeathConnections = {}
    -- æ–­å¼€è§’è‰²é˜²é”€æ¯è¿æ¥
    if GLOBAL_STATE.ConnectionPool.AntiDestroyConnection then
        pcall(function() GLOBAL_STATE.ConnectionPool.AntiDestroyConnection:Disconnect() end)
        GLOBAL_STATE.ConnectionPool.AntiDestroyConnection = nil
    end
    -- æ–­å¼€è¿œç¨‹æŒ‡ä»¤æ‹¦æˆªè¿æ¥
    for _, conn in ipairs(GLOBAL_STATE.ConnectionPool.RemoteBlockConnections) do
        if conn then pcall(function() conn:Disconnect() end) end
    end
    GLOBAL_STATE.ConnectionPool.RemoteBlockConnections = {}
    -- æ–­å¼€è§’è‰²ç›‘æ§è¿æ¥
    if GLOBAL_STATE.ConnectionPool.CharacterMonitorConnection then
        pcall(function() GLOBAL_STATE.ConnectionPool.CharacterMonitorConnection:Disconnect() end)
        GLOBAL_STATE.ConnectionPool.CharacterMonitorConnection = nil
    end
end

-- å­—ç¬¦ä¸²æ¨¡ç³ŠåŒ¹é…ï¼ˆç”¨äºæ‹¦æˆªå…³é”®è¯ç›¸å…³æ“ä½œï¼‰
local function StringFuzzyMatch(str, keywords)
    if not str or type(str) ~= "string" then return false end
    str = str:lower()
    for _, keyword in ipairs(keywords) do
        if str:find(keyword:lower()) then return true end
    end
    return false
end

-- å¼ºåˆ¶è®¾ç½®è§’è‰²å­˜æ´»çŠ¶æ€
local function ForceSetAlive(humanoid)
    if not humanoid then return end
    pcall(function()
        humanoid.Health = humanoid.MaxHealth
        humanoid.Dead = false
        humanoid.HealthState = Enum.HealthState.Alive
        if humanoid:FindFirstChild("HealthState") then
            humanoid.HealthState.Value = Enum.HealthState.Alive
        end
        GLOBAL_STATE.LastValidHealth = humanoid.MaxHealth
    end)
end

-- ==================== æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼š9å€è‡ªåŠ¨å›è¡€ ====================
local function SetupRapidHealSystem(humanoid)
    if not humanoid then return end
    DisconnectAllConnections() -- æ¸…ç†æ—§è¿æ¥é˜²æ­¢å†²çª
    
    -- åŠ¨æ€è®¡ç®—å›è¡€é€Ÿç‡ï¼ˆåŸºäºæœ€å¤§ç”Ÿå‘½å€¼ï¼Œé€‚é…ä¸åŒæ¸¸æˆï¼‰
    local baseHealPerSecond = humanoid.MaxHealth * 0.015 * GLOBAL_CONFIG.HEAL_MULTIPLIER -- åŸºç¡€å›è¡€ç‡1.5%/ç§’ Ã—9å€
    GLOBAL_STATE.ConnectionPool.HealConnection = RUN_SERVICE.Heartbeat:Connect(function(dt)
        if not humanoid or not humanoid.Parent or not GLOBAL_STATE.IsCharacterValid then return end
        
        -- åŒé‡ç”Ÿå‘½å€¼ä¿æŠ¤ï¼šé˜²æ­¢ç¬é—´æ¸…é›¶
        if humanoid.Health <= GLOBAL_STATE.LastValidHealth * 0.1 then
            humanoid.Health = GLOBAL_STATE.LastValidHealth * 0.4 -- ä¿ç•™40%è¡€
        end
        
        -- 9å€é€Ÿåº¦å›è¡€è®¡ç®—
        local healAmount = baseHealPerSecond * dt
        local newHealth = humanoid.Health + healAmount
        
        -- é™åˆ¶æœ€å¤§ç”Ÿå‘½å€¼ï¼Œé˜²æ­¢æº¢å‡º
        humanoid.Health = math.min(newHealth, humanoid.MaxHealth, GLOBAL_CONFIG.MAX_HEAL_CAP)
        
        -- æ›´æ–°æœ€åæœ‰æ•ˆç”Ÿå‘½å€¼
        if humanoid.Health > GLOBAL_STATE.LastValidHealth then
            GLOBAL_STATE.LastValidHealth = humanoid.Health
        end
        
        -- ç´§æ€¥å›è¡€è§¦å‘ï¼šç”Ÿå‘½å€¼è¿‡ä½æ—¶åŠ é€Ÿå›è¡€
        if humanoid.Health < humanoid.MaxHealth * 0.3 then
            humanoid.Health = humanoid.Health + (baseHealPerSecond * 0.5) * dt -- é¢å¤–+50%å›è¡€é€Ÿåº¦
        end
    end)
end

-- ==================== æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼šæ‹¦æˆªæŠ“å–ï¼ˆå¤šç»´åº¦é˜²å¾¡ï¼‰====================
local function SetupAntiGrabSystem(character)
    if not character then return end
    DisconnectAllConnections()
    
    local humanoidRootPart = SafeGetInstance(character, "HumanoidRootPart", "Part")
    local humanoid = SafeGetInstance(character, "Humanoid", "Humanoid")
    if not humanoidRootPart or not humanoid then return end
    
    -- é˜²å¾¡1ï¼šæ‹¦æˆªæ‰€æœ‰éè‡ªèº«å…³èŠ‚è¿æ¥ï¼ˆå¸¸è§æŠ“å–æ–¹å¼ï¼‰
    table.insert(GLOBAL_STATE.ConnectionPool.AntiGrabConnections, character.DescendantAdded:Connect(function(desc)
        if not GLOBAL_STATE.IsCharacterValid then return end
        local validJointTypes = {"Motor6D", "BallSocketConstraint", "HingeConstraint"} -- è‡ªèº«éª¨éª¼å…è®¸çš„å…³èŠ‚ç±»å‹
        local isInvalidJoint = (desc:IsA("JointInstance") or desc:IsA("Constraint")) and not table.find(validJointTypes, desc.ClassName)
        if isInvalidJoint then
            pcall(function() DEBRIS:AddItem(desc, 0.001) end) -- æé€Ÿé”€æ¯éæ³•å…³èŠ‚
        end
    end))
    
    -- é˜²å¾¡2ï¼šç›‘æ§çˆ¶å¯¹è±¡å˜æ›´ï¼ˆé˜²æ­¢è¢«æŠ“å–åˆ°å…¶ä»–æ¨¡å‹ï¼‰
    table.insert(GLOBAL_STATE.ConnectionPool.AntiGrabConnections, humanoidRootPart.Changed:Connect(function(property)
        if property == "Parent" and GLOBAL_STATE.IsCharacterValid then
            local newParent = humanoidRootPart.Parent
            if newParent and not newParent:IsDescendantOf(character) and not newParent:IsDescendantOf(WORKSPACE) then
                pcall(function() humanoidRootPart.Parent = character end) -- å¼ºåˆ¶è¿˜åŸçˆ¶å¯¹è±¡
            end
        end
    end))
    
    -- é˜²å¾¡3ï¼šæ‹¦æˆªå¼‚å¸¸åŠ›ä½œç”¨ï¼ˆæŠ“å–æ—¶çš„å¼ºåˆ¶ä½ç§»åŠ›ï¼‰
    table.insert(GLOBAL_STATE.ConnectionPool.AntiGrabConnections, humanoidRootPart.Touched:Connect(function(hit)
        if not GLOBAL_STATE.IsCharacterValid or hit.Parent == character then return end
        -- æ£€æµ‹æŠ“å–ç›¸å…³çš„åŠ›ç»„ä»¶
        local forceComponents = {hit:FindFirstChildOfClass("BodyForce"), hit:FindFirstChildOfClass("BodyVelocity"), hit:FindFirstChildOfClass("BodyPosition")}
        for _, comp in ipairs(forceComponents) do
            if comp and comp.Force.Magnitude > 8000 then
                pcall(function() comp:Destroy() end) -- é”€æ¯å¼ºæŠ“åŠ›ç»„ä»¶
            end
        end
    end))
    
    -- é˜²å¾¡4ï¼šå®æ—¶æ£€æµ‹è¿‘è·ç¦»å¼‚å¸¸å¯¹è±¡ï¼ˆé˜²æ­¢è´´è„¸æŠ“å–ï¼‰
    table.insert(GLOBAL_STATE.ConnectionPool.AntiGrabConnections, RUN_SERVICE.RenderStepped:Connect(function()
        if not humanoidRootPart or not GLOBAL_STATE.IsCharacterValid then return end
        local nearbyParts = WORKSPACE:GetPartsInPart(humanoidRootPart, OverlapParams.new())
        for _, part in ipairs(nearbyParts) do
            if part.Parent ~= character and part.Parent:FindFirstChildOfClass("Humanoid") then
                local targetPlayer = PLAYER_SERVICE:GetPlayerFromCharacter(part.Parent)
                if not targetPlayer or targetPlayer ~= player then
                    -- æ¨å¼€å¼‚å¸¸é è¿‘çš„å¯¹è±¡
                    local direction = (humanoidRootPart.Position - part.Position).Unit
                    pcall(function() part.Velocity = direction * 15 end)
                end
            end
        end
    end))
end

-- ==================== æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼šå¼ºåˆ¶æ‹¦æˆªæ­»äº¡åçªè„¸ ====================
local function SetupAntiDeathWarpSystem(character)
    if not character then return end
    DisconnectAllConnections()
    
    local humanoidRootPart = SafeGetInstance(character, "HumanoidRootPart", "Part")
    if not humanoidRootPart then return end
    
    local lastValidCFrame = humanoidRootPart.CFrame -- è®°å½•æœ€åæœ‰æ•ˆä½ç½®
    local warpLock = false -- çªè„¸é”å®šï¼ˆé˜²æ­¢é‡å¤è§¦å‘ï¼‰
    
    GLOBAL_STATE.ConnectionPool.AntiWarpConnection = RUN_SERVICE.RenderStepped:Connect(function()
        if not humanoidRootPart or not GLOBAL_STATE.IsCharacterValid or warpLock then return end
        
        -- è®¡ç®—ä½ç½®åç§»é‡
        local positionDelta = (humanoidRootPart.CFrame.Position - lastValidCFrame.Position).Magnitude
        local rotationDelta = math.abs(humanoidRootPart.CFrame.Rotation:ToEulerAnglesXYZ() - lastValidCFrame.Rotation:ToEulerAnglesXYZ()):Max()
        
        -- åˆ¤å®šçªè„¸ï¼šä½ç½®çªå˜æˆ–å¼ºåˆ¶æ—‹è½¬
        if positionDelta > GLOBAL_CONFIG.ANTI_WARP_THRESHOLD or rotationDelta > math.rad(180) then
            warpLock = true
            pcall(function()
                humanoidRootPart.CFrame = lastValidCFrame + GLOBAL_CONFIG.SAFE_POS_OFFSET -- è¿˜åŸä½ç½®å¹¶æŠ¬é«˜
            end)
            -- çŸ­æš‚é”å®šé˜²æ­¢æŠ–åŠ¨
            wait(0.05)
            warpLock = false
        end
        
        -- æ­£å¸¸ç§»åŠ¨æ—¶æ›´æ–°æœ‰æ•ˆä½ç½®
        if positionDelta < 2 then
            lastValidCFrame = humanoidRootPart.CFrame
        end
    end)
end

-- ==================== æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼šå¼ºåˆ¶æ‹¦æˆªå‰§æƒ…æ€ ====================
local function SetupAntiScriptedDeathSystem(humanoid)
    if not humanoid then return end
    DisconnectAllConnections()
    
    -- é˜²å¾¡1ï¼šHookç”Ÿå‘½å€¼è®¾ç½®ï¼ˆæ‹¦æˆªå¼ºåˆ¶æ¸…é›¶ï¼‰
    local humanoidMetatable = getmetatable(humanoid)
    if humanoidMetatable and humanoidMetatable.__newindex then
        local originalNewIndex = humanoidMetatable.__newindex
        table.insert(GLOBAL_STATE.ConnectionPool.AntiScriptedDeathConnections, humanoidMetatable.__newindex:Connect(function(t, k, v)
            if k == "Health" and type(v) == "number" then
                -- é˜»æ­¢å¼ºåˆ¶è®¾ä¸º0æˆ–è´Ÿæ•°
                if v <= 0 then
                    return originalNewIndex(t, k, humanoid.MaxHealth * 0.6) -- å¼ºåˆ¶ä¿ç•™60%è¡€
                end
                -- é˜»æ­¢å‰§æƒ…æ€é”è¡€ï¼ˆ1è¡€/å›ºå®šä½è¡€ï¼‰
                if v < humanoid.MaxHealth * 0.2 and v > 0 then
                    return originalNewIndex(t, k, humanoid.MaxHealth)
                end
            end
            return originalNewIndex(t, k, v)
        end))
    end
    
    -- é˜²å¾¡2ï¼šç›‘æ§Humanoidå…³é”®çŠ¶æ€å˜æ›´
    table.insert(GLOBAL_STATE.ConnectionPool.AntiScriptedDeathConnections, humanoid.Changed:Connect(function(property)
        if not GLOBAL_STATE.IsCharacterValid then return end
        -- å¼ºåˆ¶ä¿æŒå­˜æ´»çŠ¶æ€
        if property == "Dead" and humanoid.Dead then
            pcall(function() humanoid.Dead = false end)
        end
        if property == "HealthState" then
            pcall(function() humanoid.HealthState = Enum.HealthState.Alive end)
        end
        -- é˜²æ­¢æœ€å¤§ç”Ÿå‘½å€¼è¢«æ¶æ„ä¿®æ”¹
        if property == "MaxHealth" and humanoid.MaxHealth < 50 then
            pcall(function() humanoid.MaxHealth = 200 end) -- å¼ºåˆ¶è®¾ç½®æœ€ä½200æœ€å¤§ç”Ÿå‘½å€¼
        end
    end))
    
    -- é˜²å¾¡3ï¼šæ‹¦æˆªå‰§æƒ…æ€ç›¸å…³æœ¬åœ°è„šæœ¬
    local function blockScriptedDeathScripts()
        local scriptContainers = {player.PlayerScripts, player.StarterPlayerScripts, WORKSPACE}
        for _, container in ipairs(scriptContainers) do
            local deathScripts = container:GetDescendants()
            for _, script in ipairs(deathScripts) do
                if script:IsA("LocalScript") and StringFuzzyMatch(script.Name, GLOBAL_CONFIG.REMOTE_BLOCK_KEYWORDS) then
                    pcall(function() script.Disabled = true end)
                end
            end
        end
    end
    blockScriptedDeathScripts()
    -- ç›‘å¬æ–°è„šæœ¬æ·»åŠ ï¼ŒæŒç»­æ‹¦æˆª
    table.insert(GLOBAL_STATE.ConnectionPool.AntiScriptedDeathConnections, WORKSPACE.DescendantAdded:Connect(function(desc)
        if desc:IsA("LocalScript") and StringFuzzyMatch(desc.Name, GLOBAL_CONFIG.REMOTE_BLOCK_KEYWORDS) then
            pcall(function() desc.Disabled = true end)
        end
    end))
end

-- ==================== æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼šå¼ºåˆ¶æ‹¦æˆªæ£æ¯è§’è‰²æ­»äº¡ ====================
local function SetupAntiCharacterDestroySystem(character)
    if not character then return end
    DisconnectAllConnections()
    
    -- é˜²å¾¡1ï¼šæ‹¦æˆªè§’è‰²æ¨¡å‹é”€æ¯äº‹ä»¶
    GLOBAL_STATE.ConnectionPool.AntiDestroyConnection = character.Destroying:Connect(function()
        if GLOBAL_STATE.RespawnLock then return end
        GLOBAL_STATE.RespawnLock = true
        warn("æ£€æµ‹åˆ°è§’è‰²è¢«å¼ºåˆ¶é”€æ¯ï¼Œè§¦å‘ç´§æ€¥é‡ç”Ÿ")
        -- ç´§æ€¥é‡ç”Ÿè§’è‰²
        pcall(function()
            wait(GLOBAL_CONFIG.RESPAWN_DELAY)
            player:LoadCharacter()
        end)
        GLOBAL_STATE.RespawnLock = false
    end)
    
    -- é˜²å¾¡2ï¼šç›‘æ§è§’è‰²æ ¸å¿ƒéƒ¨ä»¶é”€æ¯ï¼ˆå¤´ã€èº¯å¹²ã€æ ¹éƒ¨ä»¶ï¼‰
    local criticalParts = {"Head", "HumanoidRootPart", "Torso", "UpperTorso", "LowerTorso"}
    table.insert(GLOBAL_STATE.ConnectionPool.AntiGrabConnections, character.DescendantRemoving:Connect(function(desc)
        if not GLOBAL_STATE.IsCharacterValid then return end
        if table.find(criticalParts, desc.Name) then
            -- æ ¸å¿ƒéƒ¨ä»¶è¢«é”€æ¯ï¼Œç´§æ€¥æ¢å¤
            pcall(function()
                local newPart = Instance.new("Part")
                newPart.Name = desc.Name
                newPart.Size = desc.Size
                newPart.CFrame = desc.CFrame
                newPart.Parent = character
                newPart.CanCollide = true
                newPart.Anchored = false
                -- é‡æ–°ç»‘å®šHumanoid
                if desc.Name == "HumanoidRootPart" then
                    local humanoid = SafeGetInstance(character, "Humanoid", "Humanoid")
                    if humanoid then
                        humanoid.RootPart = newPart
                    end
                end
            end)
        end
    end))
    
    -- é˜²å¾¡3ï¼šå®æ—¶æ£€æµ‹è§’è‰²å®Œæ•´æ€§
    table.insert(GLOBAL_STATE.ConnectionPool.AntiGrabConnections, RUN_SERVICE.Heartbeat:Connect(function()
        if not character or not character:IsDescendantOf(WORKSPACE) then return end
        -- æ£€æŸ¥æ ¸å¿ƒéƒ¨ä»¶æ˜¯å¦å­˜åœ¨
        for _, partName in ipairs(criticalParts) do
            local part = character:FindFirstChild(partName)
            if not part or not part:IsA("Part") then
                -- ç¼ºå¤±æ ¸å¿ƒéƒ¨ä»¶ï¼Œè§¦å‘ä¿®å¤
                pcall(function()
                    local newPart = Instance.new("Part")
                    newPart.Name = partName
                    newPart.Size = Vector3.new(2, 2, 2) -- é€šç”¨å°ºå¯¸
                    newPart.CFrame = character:FindFirstChild("HumanoidRootPart") and character.HumanoidRootPart.CFrame or CFrame.new(0, 10, 0)
                    newPart.Parent = character
                    newPart.CanCollide = true
                    newPart.Anchored = false
                end)
            end
        end
    end))
end

-- ==================== æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼šå¼ºåˆ¶æ‹¦æˆªè¿œç¨‹æŒ‡ä»¤æ­»äº¡ ====================
local function SetupRemoteDeathBlockSystem()
    DisconnectAllConnections()
    
    -- é˜²å¾¡1ï¼šæ‹¦æˆªRemoteEventè¿œç¨‹æ­»äº¡æŒ‡ä»¤
    local function blockRemoteEvents(container)
        if not container then return end
        local remotes = container:GetDescendants()
        for _, remote in ipairs(remotes) do
            if remote:IsA("RemoteEvent") and StringFuzzyMatch(remote.Name, GLOBAL_CONFIG.REMOTE_BLOCK_KEYWORDS) and not GLOBAL_STATE.BlockedRemoteEvents[remote] then
                GLOBAL_STATE.BlockedRemoteEvents[remote] = true
                local originalOnClientEvent = remote.OnClientEvent
                remote.OnClientEvent = function(...)
                    local args = {...}
                    -- æ£€æµ‹æ˜¯å¦é’ˆå¯¹å½“å‰ç©å®¶çš„æ­»äº¡æŒ‡ä»¤
                    local isTargetPlayer = false
                    for _, arg in ipairs(args) do
                        if arg == player or (arg and arg:IsA("Player") and arg == player) then
                            isTargetPlayer = true
                            break
                        end
                    end
                    if isTargetPlayer then
                        warn("æ‹¦æˆªè¿œç¨‹æ­»äº¡æŒ‡ä»¤ï¼š", remote.Name)
                        ForceSetAlive(GLOBAL_STATE.HumanoidReference) -- å¼ºåˆ¶å›è¡€å­˜æ´»
                        return -- æ‹¦æˆªæŒ‡ä»¤æ‰§è¡Œ
                    end
                    -- éç›®æ ‡æŒ‡ä»¤æ­£å¸¸æ‰§è¡Œ
                    if originalOnClientEvent then
                        originalOnClientEvent(...)
                    end
                end
            end
        end
    end
    
    -- é˜²å¾¡2ï¼šæ‹¦æˆªRemoteFunctionè¿œç¨‹æ­»äº¡æŒ‡ä»¤
    local function blockRemoteFunctions(container)
        if not container then return end
        local remotes = container:GetDescendants()
        for _, remote in ipairs(remotes) do
            if remote:IsA("RemoteFunction") and StringFuzzyMatch(remote.Name, GLOBAL_CONFIG.REMOTE_BLOCK_KEYWORDS) and not GLOBAL_STATE.BlockedRemoteFunctions[remote] then
                GLOBAL_STATE.BlockedRemoteFunctions[remote] = true
                local originalInvokeClient = remote.InvokeClient
                remote.InvokeClient = function(...)
                    local args = {...}
                    local isTargetPlayer = false
                    for _, arg in ipairs(args) do
                        if arg == player or (arg and arg:IsA("Player") and arg == player) then
                            isTargetPlayer = true
                            break
                        end
                    end
                    if isTargetPlayer then
                        warn("æ‹¦æˆªè¿œç¨‹æ­»äº¡å‡½æ•°ï¼š", remote.Name)
                        ForceSetAlive(GLOBAL_STATE.HumanoidReference)
                        return false -- è¿”å›æ— æ•ˆå€¼é˜»æ­¢æ‰§è¡Œ
                    end
                    if originalInvokeClient then
                        return originalInvokeClient(...)
                    end
                end
            end
        end
    end
    
    -- åˆå§‹åŒ–æ‹¦æˆªæ‰€æœ‰å®¹å™¨ä¸­çš„è¿œç¨‹æŒ‡ä»¤
    local remoteContainers = {REPLICATED_STORAGE, WORKSPACE, game:GetService("StarterPack"), game:GetService("StarterGui")}
    for _, container in ipairs(remoteContainers) do
        blockRemoteEvents(container)
        blockRemoteFunctions(container)
    end
    
    -- ç›‘å¬æ–°è¿œç¨‹å¯¹è±¡æ·»åŠ ï¼ŒæŒç»­æ‹¦æˆª
    table.insert(GLOBAL_STATE.ConnectionPool.RemoteBlockConnections, REPLICATED_STORAGE.DescendantAdded:Connect(function(desc)
        blockRemoteEvents(REPLICATED_STORAGE)
        blockRemoteFunctions(REPLICATED_STORAGE)
    end))
    table.insert(GLOBAL_STATE.ConnectionPool.RemoteBlockConnections, WORKSPACE.DescendantAdded:Connect(function(desc)
        blockRemoteEvents(WORKSPACE)
        blockRemoteFunctions(WORKSPACE)
    end))
    
    -- é˜²å¾¡3ï¼šæ‹¦æˆªAdminæŒ‡ä»¤ï¼ˆå¸¸è§è¿œç¨‹æ­»äº¡æ¥æºï¼‰
    table.insert(GLOBAL_STATE.ConnectionPool.RemoteBlockConnections, RUN_SERVICE.Heartbeat:Connect(function()
        if player:FindFirstChild("PlayerGui") then
            local adminGuis = player.PlayerGui:GetDescendants()
            for _, gui in ipairs(adminGuis) do
                if gui:IsA("TextButton") and StringFuzzyMatch(gui.Name, {"Kill", "Ban", "Destroy"}) then
                    pcall(function() gui.Visible = false end)
                end
            end
        end
    end))
end

-- ==================== æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼šæ— é™é‡ç”Ÿ+åŸåœ°å¤æ´» ====================
local function SetupInfiniteRespawnSystem(character)
    if not character then return end
    local humanoid = SafeGetInstance(character, "Humanoid", "Humanoid")
    if not humanoid then return end
    
    -- è®°å½•åˆå§‹ä½ç½®ï¼ˆé¦–æ¬¡åŠ è½½æ—¶ï¼‰
    local humanoidRootPart = SafeGetInstance(character, "HumanoidRootPart", "Part")
    if humanoidRootPart and not GLOBAL_STATE.LastDeathCFrame then
        GLOBAL_STATE.LastDeathCFrame = humanoidRootPart.CFrame
    end
    
    -- ç»‘å®šæ­»äº¡äº‹ä»¶ï¼ˆè§¦å‘æ— é™é‡ç”Ÿï¼‰
    humanoid.Died:Connect(function()
        if GLOBAL_STATE.RespawnLock then return end
        GLOBAL_STATE.RespawnLock = true
        warn("è§¦å‘æ­»äº¡ï¼Œæ‰§è¡Œæ— é™åŸåœ°é‡ç”Ÿ")
        
        -- è®°å½•å½“å‰æ­»äº¡ä½ç½®ï¼ˆè¦†ç›–æ—§ä½ç½®ï¼‰
        local deathRootPart = SafeGetInstance(character, "HumanoidRootPart", "Part")
        if deathRootPart then
            GLOBAL_STATE.LastDeathCFrame = deathRootPart.CFrame
        end
        
        -- çŸ­æš‚å»¶è¿Ÿæ¸…ç†
        wait(GLOBAL_CONFIG.RESPAWN_DELAY)
        
        -- ç ´è§£ä¸€å‘½é‡ç”Ÿé™åˆ¶
        pcall(function()
            player:SetAttribute("CanRespawn", true)
            player:SetAttribute("RespawnLimit", math.huge)
            player:SetAttribute("OneLife", false)
            player:SetAttribute("NoRespawn", false)
            -- è¦†ç›–æ¸¸æˆå†…ç½®é‡ç”Ÿè®¡æ•°
            if player:FindFirstChild("leaderstats") then
                local respawnCount = player.leaderstats:FindFirstChild("Respawns")
                if respawnCount then
                    respawnCount.Value = math.huge
                end
            end
        end)
        
        -- å¼ºåˆ¶é‡ç”Ÿï¼ˆæ— è§†æ¸¸æˆé™åˆ¶ï¼‰
        pcall(function() player:LoadCharacter() end)
        
        -- ç­‰å¾…æ–°è§’è‰²åŠ è½½å®Œæˆ
        local newCharacter = nil
        repeat
            wait(0.01)
            newCharacter = player.Character
        until newCharacter
        
        -- æ›´æ–°å…¨å±€è§’è‰²å¼•ç”¨
        GLOBAL_STATE.CharacterReference = newCharacter
        local newHumanoid = SafeGetInstance(newCharacter, "Humanoid", "Humanoid")
        local newRootPart = SafeGetInstance(newCharacter, "HumanoidRootPart", "Part")
        GLOBAL_STATE.HumanoidReference = newHumanoid
        
        -- åŸåœ°å¤æ´»ï¼šè®¾ç½®åˆ°æ­»äº¡ä½ç½®
        if newRootPart and GLOBAL_STATE.LastDeathCFrame then
            pcall(function()
                newRootPart.CFrame = GLOBAL_STATE.LastDeathCFrame + GLOBAL_CONFIG.SAFE_POS_OFFSET
            end)
        end
        
        -- ç ´è§£å¼ºåˆ¶è§‚æˆ˜
        pcall(function()
            -- é€€å‡ºè§‚æˆ˜çŠ¶æ€
            player:SetAttribute("InSpectatorMode", false)
            player:SetAttribute("Spectating", false)
            -- é”€æ¯è§‚æˆ˜UI
            local playerGui = SafeGetInstance(player, "PlayerGui", "PlayerGui")
            if playerGui then
                for _, gui in ipairs(playerGui:GetChildren()) do
                    if StringFuzzyMatch(gui.Name, {"Spectator", "è§‚æˆ˜", "Observer", "View"}) then
                        gui:Destroy()
                    end
                end
            end
            -- ç¦ç”¨è§‚æˆ˜è„šæœ¬
            if player:FindFirstChild("PlayerScripts") then
                local spectatorScripts = player.PlayerScripts:GetDescendants()
                for _, script in ipairs(spectatorScripts) do
                    if StringFuzzyMatch(script.Name, {"Spectator", "è§‚æˆ˜"}) then
                        script.Disabled = true
                    end
                end
            end
        end)
        
        -- é‡æ–°ç»‘å®šæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½åˆ°æ–°è§’è‰²
        SetupRapidHealSystem(newHumanoid)
        SetupAntiGrabSystem(newCharacter)
        SetupAntiDeathWarpSystem(newCharacter)
        SetupAntiScriptedDeathSystem(newHumanoid)
        SetupAntiCharacterDestroySystem(newCharacter)
        SetupRemoteDeathBlockSystem()
        
        -- å¼ºåˆ¶è®¾ç½®æ»¡è¡€
        ForceSetAlive(newHumanoid)
        
        -- è§£é”é‡ç”Ÿé”
        GLOBAL_STATE.RespawnLock = false
        GLOBAL_STATE.IsCharacterValid = true
    end)
end

-- ==================== æ ¸å¿ƒè§’è‰²åˆå§‹åŒ–ï¼ˆé€šç”¨é€‚é…ï¼‰====================
local function OnCharacterAdded(character)
    -- é‡ç½®å…¨å±€çŠ¶æ€
    GLOBAL_STATE.CharacterReference = character
    GLOBAL_STATE.IsCharacterValid = false
    GLOBAL_STATE.LastValidHealth = 100
    DisconnectAllConnections() -- æ¸…ç†æ—§è¿æ¥
    
    -- ç­‰å¾…æ ¸å¿ƒç»„ä»¶åŠ è½½ï¼ˆå…¼å®¹å»¶è¿Ÿç”Ÿæˆï¼‰
    local humanoid = nil
    local humanoidRootPart = nil
    repeat
        wait(0.01)
        humanoid = SafeGetInstance(character, "Humanoid", "Humanoid")
        humanoidRootPart = SafeGetInstance(character, "HumanoidRootPart", "Part")
    until humanoid and humanoidRootPart and character:IsDescendantOf(WORKSPACE)
    
    -- æ›´æ–°å…¨å±€å¼•ç”¨
    GLOBAL_STATE.HumanoidReference = humanoid
    GLOBAL_STATE.LastValidHealth = humanoid.MaxHealth
    
    -- åŸºç¡€å±æ€§å¼ºåŒ–ï¼ˆæ‰‹æœºç«¯ç”Ÿå­˜ä¼˜åŒ–ï¼‰
    pcall(function()
        humanoid.MaxHealth = humanoid.MaxHealth * 2 -- ç¿»å€æœ€å¤§ç”Ÿå‘½å€¼
        humanoid.Health = humanoid.MaxHealth -- ç”Ÿæˆæ—¶æ»¡è¡€
        humanoid.WalkSpeed = humanoid.WalkSpeed * 1.2 -- æå‡20%ç§»åŠ¨é€Ÿåº¦ï¼ˆæ‰‹æœºç«¯æ“ä½œä¼˜åŒ–ï¼‰
        humanoid.JumpPower = humanoid.JumpPower * 1.1 -- æå‡10%è·³è·ƒåŠ›
    end)
    
    -- ç»‘å®šæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
    SetupRapidHealSystem(humanoid)
    SetupAntiGrabSystem(character)
    SetupAntiDeathWarpSystem(character)
    SetupAntiScriptedDeathSystem(humanoid)
    SetupAntiCharacterDestroySystem(character)
    SetupRemoteDeathBlockSystem()
    SetupInfiniteRespawnSystem(character)
    
    -- è§’è‰²ç›‘æ§ï¼šé˜²æ­¢åŠŸèƒ½å¤±æ•ˆ
    GLOBAL_STATE.ConnectionPool.CharacterMonitorConnection = RUN_SERVICE.Heartbeat:Connect(function()
        if not character or not character:IsDescendantOf(WORKSPACE) then
            GLOBAL_STATE.IsCharacterValid = false
            pcall(function() player:LoadCharacter() end)
            return
        end
        if not humanoid or humanoid.Health <= 0 then
            ForceSetAlive(humanoid)
        end
        GLOBAL_STATE.IsCharacterValid = true
    end)
    
    -- åˆå§‹åŒ–å®Œæˆæ ‡è®°
    GLOBAL_STATE.IsCharacterValid = true
    print("[æ‰‹æœºç«¯é€šç”¨è„šæœ¬] è§’è‰²åˆå§‹åŒ–å®Œæˆï¼Œæ‰€æœ‰åŠŸèƒ½å·²æ¿€æ´»")
end

-- ==================== å…¨å±€åˆå§‹åŒ–ä¸é”™è¯¯å¤„ç† ====================
-- ç»‘å®šè§’è‰²åŠ è½½äº‹ä»¶
player.CharacterAdded:Connect(OnCharacterAdded)

-- é¦–æ¬¡åŠ è½½å¤„ç†ï¼ˆè§’è‰²å·²å­˜åœ¨æ—¶ï¼‰
if player.Character then
    OnCharacterAdded(player.Character)
else
    -- ç­‰å¾…é¦–æ¬¡è§’è‰²ç”Ÿæˆï¼ˆå…¼å®¹å»¶è¿ŸåŠ è½½ï¼‰
    repeat
        wait(0.1)
    until player.Character
    OnCharacterAdded(player.Character)
end

-- å…¨å±€é”™è¯¯æ•è·ï¼ˆé˜²æ­¢è„šæœ¬å´©æºƒï¼‰
SCRIPT_CONTEXT.Error:Connect(function(err)
    warn("[è„šæœ¬é”™è¯¯] é”™è¯¯ä¿¡æ¯:", err)
    -- é”™è¯¯æ¢å¤ï¼šé‡æ–°åˆå§‹åŒ–è§’è‰²
    pcall(function()
        if GLOBAL_STATE.CharacterReference and GLOBAL_STATE.CharacterReference:IsDescendantOf(WORKSPACE) then
            OnCharacterAdded(GLOBAL_STATE.CharacterReference)
        else
            player:LoadCharacter()
        end
    end)
end)

-- æ‰‹æœºç«¯è¾“å…¥é€‚é…ï¼ˆé˜²æ­¢æ“ä½œå†²çªï¼‰
USER_INPUT_SERVICE.TouchTap:Connect(function()
    if GLOBAL_STATE.HumanoidReference and GLOBAL_STATE.HumanoidReference.Health < GLOBAL_STATE.HumanoidReference.MaxHealth * 0.5 then
        -- è§¦æ‘¸å±å¹•æ—¶è§¦å‘ç´§æ€¥å›è¡€
        GLOBAL_STATE.HumanoidReference.Health = GLOBAL_STATE.HumanoidReference.Health + GLOBAL_STATE.HumanoidReference.MaxHealth * 0.1
    end
end)

-- è„šæœ¬åŠ è½½å®Œæˆæç¤º
print("=" .. string.rep("-", 50) .. "=")
print("ğŸ“± æ‰‹æœºç«¯é€šç”¨è¶…å¼ºåŠŸèƒ½è„šæœ¬åŠ è½½å®Œæˆï¼")
print("ğŸ’– æ ¸å¿ƒåŠŸèƒ½ï¼š")
print("   - 9å€è‡ªåŠ¨å›è¡€ï¼ˆç´§æ€¥çŠ¶æ€é¢å¤–åŠ é€Ÿï¼‰")
print("   - åŸåœ°æ— é™é‡ç”Ÿï¼ˆç²¾å‡†è¿˜åŸæ­»äº¡ä½ç½®ï¼‰")
print("   - å…¨ç»´åº¦æŠ“å–æ‹¦æˆªï¼ˆ4é‡é˜²å¾¡æœºåˆ¶ï¼‰")
print("   - æ­»äº¡çªè„¸å¼ºåˆ¶æ‹¦æˆªï¼ˆä½ç½®é”å®šï¼‰")
print("   - å‰§æƒ…æ€100%æ‹¦æˆªï¼ˆHook+è„šæœ¬ç¦ç”¨ï¼‰")
print("   - è§’è‰²é˜²æ£æ¯ï¼ˆæ ¸å¿ƒéƒ¨ä»¶è‡ªåŠ¨ä¿®å¤ï¼‰")
print("   - è¿œç¨‹æ­»äº¡æŒ‡ä»¤æ‹¦æˆªï¼ˆå…³é”®è¯å…¨åŒ¹é…ï¼‰")
print("   - ç ´è§£ä¸€å‘½é‡ç”Ÿ+å¼ºåˆ¶è§‚æˆ˜")
print("âš¡ é¢å¤–ä¼˜åŒ–ï¼š")
print("   - æœ€å¤§ç”Ÿå‘½å€¼ç¿»å€+ç§»åŠ¨é€Ÿåº¦æå‡")
print("   - æ‰‹æœºç«¯è§¦æ‘¸ç´§æ€¥å›è¡€")
print("   - å…¨å±€é”™è¯¯è‡ªåŠ¨æ¢å¤")
print("   - å…¨Robloxæ¸¸æˆé€šç”¨é€‚é…")
print("=" .. string.rep("-", 50) .. "=")
]])()

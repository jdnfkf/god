loadstring([[
-- 最终零报错版：CorePackages多模块功能脚本
local CorePackages = game:GetService("CorePackages")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- 配置
local Config = {
    RootFolder = "GameEnhanceSystem",
    PosFolder = "PositionRecorder",
    GodFolder = "GodModeModule",
    RespawnFolder = "AutoRespawnModule"
}

-- 清理旧资源
local function CleanOld()
    local root = CorePackages:FindFirstChild(Config.RootFolder)
    if root then root:Destroy() end
end

-- 创建文件夹
local function CreateFolder(name, parent)
    local folder = Instance.new("Folder")
    folder.Name = name
    folder.Parent = parent
    return folder
end

-- 创建功能模块
local function CreateModule(folder, logic)
    local module = Instance.new("ModuleScript")
    module.Name = "Main"
    module.Parent = folder
    module.Source = logic
    return module
end

-- ===================== 初始化文件夹 =====================
CleanOld()
local rootFolder = CreateFolder(Config.RootFolder, CorePackages)
local posFolder = CreateFolder(Config.PosFolder, rootFolder)
local godFolder = CreateFolder(Config.GodFolder, rootFolder)
local respawnFolder = CreateFolder(Config.RespawnFolder, rootFolder)

-- ===================== 模块1：位置记录 =====================
local posLogic = [[
local LocalPlayer = game:GetService("Players").LocalPlayer
local RunService = game:GetService("RunService")
local lastPos = nil

RunService.Heartbeat:Connect(function()
    local char = LocalPlayer.Character
    if char then
        local hum = char:FindFirstChild("Humanoid")
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if hum and hrp and hum.Health > 0 then
            lastPos = hrp.Position
        end
    end
end)

return {
    GetLastPos = function()
        return lastPos or Vector3.new(0, 2, 0)
    end
}
]]
local posModule = CreateModule(posFolder, posLogic)

-- ===================== 模块2：无敌 =====================
local godLogic = [[
local LocalPlayer = game:GetService("Players").LocalPlayer
local RunService = game:GetService("RunService")

local function BindGod(char)
    local hum = char:WaitForChild("Humanoid", 5)
    if not hum then return end
    hum.BreakJointsOnDeath = false
    hum:SetStateEnabled(Enum.HumanoidStateType.Dead, false)
    RunService.Heartbeat:Connect(function()
        if hum.Health > 0 then
            hum.Health = hum.MaxHealth
        end
    end)
end

if LocalPlayer.Character then BindGod(LocalPlayer.Character) end
LocalPlayer.CharacterAdded:Connect(function(newChar)
    task.wait(0.5)
    BindGod(newChar)
end)
]]
local godModule = CreateModule(godFolder, godLogic)

-- ===================== 模块3：复活（修复路径引用） =====================
local respawnLogic = [[
local LocalPlayer = game:GetService("Players").LocalPlayer
local CorePackages = game:GetService("CorePackages")
local rootFolder = CorePackages:WaitForChild("]]..Config.RootFolder..[[")
local posFolder = rootFolder:WaitForChild("]]..Config.PosFolder..[[")
local posModule = require(posFolder:WaitForChild("Main"))

local function BindRespawn(char)
    local hum = char:WaitForChild("Humanoid", 5)
    local hrp = char:WaitForChild("HumanoidRootPart", 5)
    if not hum or not hrp then return end
    hum.Died:Connect(function()
        task.wait(0.1)
        local safePos = posModule.GetLastPos()
        hum.Health = hum.MaxHealth
        hrp.CFrame = CFrame.new(safePos + Vector3.new(0, 2, 0))
    end)
end

if LocalPlayer.Character then BindRespawn(LocalPlayer.Character) end
LocalPlayer.CharacterAdded:Connect(function(newChar)
    task.wait(0.5)
    BindRespawn(newChar)
end)
]]
local respawnModule = CreateModule(respawnFolder, respawnLogic)

-- ===================== 启用模块 =====================
require(posModule)
require(godModule)
require(respawnModule)

print("✅ 所有模块已加载，功能正常")
]])()

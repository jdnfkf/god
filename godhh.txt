loadstring([[
-- ==============================================
-- CorePackages多模块功能脚本（零报错）
-- 功能：位置记录、无敌、复活分模块存储
-- ==============================================
local CorePackages = game:GetService("CorePackages")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- 配置：文件夹/模块命名
local Config = {
    RootFolder = "GameEnhanceSystem",
    PosFolder = "PositionRecorder",
    GodFolder = "GodModeModule",
    RespawnFolder = "AutoRespawnModule"
}

-- 工具：清理旧资源
local function CleanOld()
    local root = CorePackages:FindFirstChild(Config.RootFolder)
    if root then root:Destroy() end
end

-- 工具：创建文件夹
local function CreateFolder(name, parent)
    local folder = Instance.new("Folder")
    folder.Name = name
    folder.Parent = parent
    return folder
end

-- 工具：创建功能模块（写入完整逻辑）
local function CreateModule(folder, logic)
    local module = Instance.new("ModuleScript")
    module.Name = "Main"
    module.Parent = folder
    module.Source = logic
    return module
end

-- ===================== 步骤1：初始化CorePackages文件夹 =====================
CleanOld()
local rootFolder = CreateFolder(Config.RootFolder, CorePackages)
local posFolder = CreateFolder(Config.PosFolder, rootFolder)
local godFolder = CreateFolder(Config.GodFolder, rootFolder)
local respawnFolder = CreateFolder(Config.RespawnFolder, rootFolder)

-- ===================== 模块1：位置记录（CorePackages/GameEnhanceSystem/PositionRecorder） =====================
local posLogic = [[
local LocalPlayer = game:GetService("Players").LocalPlayer
local RunService = game:GetService("RunService")
local lastPos = nil

-- 实时记录位置
RunService.Heartbeat:Connect(function()
    local char = LocalPlayer.Character
    if char then
        local hum = char:FindFirstChild("Humanoid")
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if hum and hrp and hum.Health > 0 then
            lastPos = hrp.Position
        end
    end
end)

-- 对外接口
return {
    GetLastPos = function()
        return lastPos or Vector3.new(0, 2, 0)
    end
}
]]
local posModule = CreateModule(posFolder, posLogic)

-- ===================== 模块2：无敌（CorePackages/GameEnhanceSystem/GodModeModule） =====================
local godLogic = [[
local LocalPlayer = game:GetService("Players").LocalPlayer
local RunService = game:GetService("RunService")

-- 无敌逻辑
local function BindGod(char)
    local hum = char:WaitForChild("Humanoid", 5)
    if not hum then return end
    hum.BreakJointsOnDeath = false
    hum:SetStateEnabled(Enum.HumanoidStateType.Dead, false)
    RunService.Heartbeat:Connect(function()
        if hum.Health > 0 then
            hum.Health = hum.MaxHealth
        end
    end)
end

-- 绑定当前角色
if LocalPlayer.Character then BindGod(LocalPlayer.Character) end
-- 角色切换重绑定
LocalPlayer.CharacterAdded:Connect(function(newChar)
    task.wait(0.5)
    BindGod(newChar)
end)
]]
local godModule = CreateModule(godFolder, godLogic)

-- ===================== 模块3：复活（CorePackages/GameEnhanceSystem/AutoRespawnModule） =====================
local respawnLogic = [[
local LocalPlayer = game:GetService("Players").LocalPlayer
local posModule = require(game:GetService("CorePackages").]]..Config.RootFolder..[[.]]..Config.PosFolder..[[.Main)

-- 复活逻辑
local function BindRespawn(char)
    local hum = char:WaitForChild("Humanoid", 5)
    local hrp = char:WaitForChild("HumanoidRootPart", 5)
    if not hum or not hrp then return end
    hum.Died:Connect(function()
        task.wait(0.1)
        local safePos = posModule.GetLastPos()
        hum.Health = hum.MaxHealth
        hrp.CFrame = CFrame.new(safePos + Vector3.new(0, 2, 0))
    end)
end

-- 绑定当前角色
if LocalPlayer.Character then BindRespawn(LocalPlayer.Character) end
-- 角色切换重绑定
LocalPlayer.CharacterAdded:Connect(function(newChar)
    task.wait(0.5)
    BindRespawn(newChar)
end)
]]
local respawnModule = CreateModule(respawnFolder, respawnLogic)

-- ===================== 加载并启用所有模块 =====================
require(posModule)
require(godModule)
require(respawnModule)

-- 提示
print("✅ CorePackages模块已部署：")
print("1. "..Config.RootFolder.."/"..Config.PosFolder.."（位置记录）")
print("2. "..Config.RootFolder.."/"..Config.GodFolder.."（无敌）")
print("3. "..Config.RootFolder.."/"..Config.RespawnFolder.."（复活）")
]])()

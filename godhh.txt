loadstring([[
-- ==============================================
-- 修复版：Roblox手机端多模块无敌+原地复活脚本
-- 核心修复：解决UpdateTimer nil索引问题
-- ==============================================
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

-- 全局配置中心
local GlobalConfig = {
    POSITION_MODULE_NAME = "SafePositionRecorder_Module",
    GODMODE_MODULE_NAME = "GodModeCore_Module",
    RESPAWN_MODULE_NAME = "AutoRespawnBinder_Module",
    POS_UPDATE_INTERVAL = 0.12,
    RESPAWN_OFFSET = 2.8,
    CHAR_LOAD_DELAY = 1.1,
    LOG_LEVEL = "DETAIL",
    VERSION = "v4.0.1 (Fixed Nil Issue)"
}

-- 全局日志系统
local GlobalLogger = {
    Log = function(moduleName, message, level)
        level = level or "INFO"
        if GlobalConfig.LOG_LEVEL == "DETAIL" then
            local timestamp = os.date("%H:%M:%S.%3f"):sub(1, 12)
            print(string.format("[%s][%s][%s] %s", timestamp, moduleName, level, message))
        end
    end,
    Success = function(moduleName, message)
        GlobalLogger.Log(moduleName, message, "SUCCESS")
    end,
    Debug = function(moduleName, message)
        GlobalLogger.Log(moduleName, message, "DEBUG")
    end,
    Warn = function(moduleName, message)
        GlobalLogger.Log(moduleName, message, "WARN")
    end
}

-- 模块管理工具
local ModuleManager = {
    CleanOldModules = function()
        local oldModules = {
            Workspace:FindFirstChild(GlobalConfig.POSITION_MODULE_NAME),
            Workspace:FindFirstChild(GlobalConfig.GODMODE_MODULE_NAME),
            Workspace:FindFirstChild(GlobalConfig.RESPAWN_MODULE_NAME)
        }
        for _, module in ipairs(oldModules) do
            if module then
                module:Destroy()
                GlobalLogger.Warn("ModuleManager", "已清理旧模块：" .. module.Name)
            end
        end
    end,
    CreateBaseModule = function(moduleName)
        local module = Instance.new("ModuleScript")
        module.Name = moduleName
        module.Parent = Workspace
        GlobalLogger.Success("ModuleManager", "模块创建成功：" .. moduleName)
        return module
    end
}

-- 模块1：实时记录安全位置（修复UpdateTimer nil问题）
local function CreateSafePositionModule()
    local module = ModuleManager.CreateBaseModule(GlobalConfig.POSITION_MODULE_NAME)
    -- 初始化moduleData为非nil表
    local moduleData = {
        LastSafePosition = nil,
        UpdateTimer = 0,
        IsRunning = true
    }

    local function UpdateSafePosition(deltaTime)
        -- 先判断moduleData是否存在
        if not moduleData or not moduleData.IsRunning then return end
        moduleData.UpdateTimer = moduleData.UpdateTimer + deltaTime
        if moduleData.UpdateTimer >= GlobalConfig.POS_UPDATE_INTERVAL then
            local character = LocalPlayer.Character
            if not character then return end
            local humanoid = character:FindFirstChild("Humanoid")
            local hrp = character:FindFirstChild("HumanoidRootPart")
            if humanoid and hrp and humanoid.Health > 0 then
                moduleData.LastSafePosition = hrp.Position
                GlobalLogger.Debug(module.Name, "安全位置更新：" .. tostring(moduleData.LastSafePosition))
            end
            moduleData.UpdateTimer = 0
        end
    end

    local function InitModule()
        GlobalLogger.Log(module.Name, "位置记录模块初始化中...")
        RunService.Heartbeat:Connect(UpdateSafePosition)
        LocalPlayer.CharacterAdded:Connect(function()
            task.wait(GlobalConfig.CHAR_LOAD_DELAY / 2)
            -- 重置时确保moduleData存在
            if moduleData then
                moduleData.LastSafePosition = nil
            end
            GlobalLogger.Debug(module.Name, "角色切换，位置记录重置")
        end)
        GlobalLogger.Success(module.Name, "位置记录模块初始化完成")
    end

    module:SetAttribute("GetLastSafePos", function()
        return (moduleData and moduleData.LastSafePosition) or Vector3.new(0, GlobalConfig.RESPAWN_OFFSET, 0)
    end)
    module:SetAttribute("StartRecording", function()
        if moduleData then
            moduleData.IsRunning = true
        end
        GlobalLogger.Debug(module.Name, "位置记录已启动")
    end)
    module:SetAttribute("StopRecording", function()
        if moduleData then
            moduleData.IsRunning = false
        end
        GlobalLogger.Debug(module.Name, "位置记录已停止")
    end)

    InitModule()
    return module
end

-- 模块2：强制维持满血量+禁用死亡机制
local function CreateGodModeModule()
    local module = ModuleManager.CreateBaseModule(GlobalConfig.GODMODE_MODULE_NAME)
    local moduleData = {
        HumanoidConnections = {},
        IsGodModeEnabled = true
    }

    local function BindGodModeToCharacter(character)
        if not character then return end
        local humanoid = character:FindFirstChild("Humanoid")
        if not humanoid then
            humanoid = character:WaitForChild("Humanoid", 15)
            if not humanoid then
                GlobalLogger.Warn(module.Name, "角色人形对象加载失败")
                return
            end
        end

        humanoid.BreakJointsOnDeath = false
        humanoid:SetStateEnabled(Enum.HumanoidStateType.Dead, false)
        humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown, false)
        GlobalLogger.Debug(module.Name, "死亡机制已禁用")

        local conn = RunService.Heartbeat:Connect(function()
            if moduleData and moduleData.IsGodModeEnabled and humanoid.Health > 0 then
                if humanoid.Health < humanoid.MaxHealth then
                    humanoid.Health = humanoid.MaxHealth
                    GlobalLogger.Debug(module.Name, "血量已恢复至满值")
                end
            end
        end)

        table.insert(moduleData.HumanoidConnections, conn)
    end

    local function InitModule()
        GlobalLogger.Log(module.Name, "无敌模块初始化中...")
        if LocalPlayer.Character then
            BindGodModeToCharacter(LocalPlayer.Character)
        end
        LocalPlayer.CharacterAdded:Connect(function(newChar)
            task.wait(GlobalConfig.CHAR_LOAD_DELAY)
            if moduleData then
                for _, conn in ipairs(moduleData.HumanoidConnections) do
                    if conn then conn:Disconnect() end
                end
                moduleData.HumanoidConnections = {}
            end
            BindGodModeToCharacter(newChar)
            GlobalLogger.Debug(module.Name, "角色切换，重新绑定无敌逻辑")
        end)
        GlobalLogger.Success(module.Name, "无敌模块初始化完成")
    end

    module:SetAttribute("EnableGodMode", function()
        if moduleData then
            moduleData.IsGodModeEnabled = true
        end
        GlobalLogger.Debug(module.Name, "无敌模式已开启")
    end)
    module:SetAttribute("DisableGodMode", function()
        if moduleData then
            moduleData.IsGodModeEnabled = false
        end
        GlobalLogger.Debug(module.Name, "无敌模式已关闭")
    end)
    module:SetAttribute("IsGodModeActive", function()
        return moduleData and moduleData.IsGodModeEnabled or false
    end)

    InitModule()
    return module
end

-- 模块3：角色切换自动重新绑定+原地复活
local function CreateAutoRespawnModule()
    local module = ModuleManager.CreateBaseModule(GlobalConfig.RESPAWN_MODULE_NAME)
    local moduleData = {
        RespawnConnections = {},
        IsRespawnEnabled = true,
        PositionModule = nil
    }

    local function GetPositionModule()
        if not moduleData.PositionModule then
            moduleData.PositionModule = Workspace:FindFirstChild(GlobalConfig.POSITION_MODULE_NAME)
            if not moduleData.PositionModule then
                GlobalLogger.Warn(module.Name, "位置模块未找到，重试获取...")
                task.wait(0.3)
                GetPositionModule()
            end
        end
        return moduleData.PositionModule
    end

    local function BindRespawnToCharacter(character)
        if not character then return end
        local humanoid = character:FindFirstChild("Humanoid")
        local hrp = character:FindFirstChild("HumanoidRootPart")
        if not humanoid or not hrp then
            humanoid = character:WaitForChild("Humanoid", 15)
            hrp = character:WaitForChild("HumanoidRootPart", 15)
            if not humanoid or not hrp then
                GlobalLogger.Warn(module.Name, "角色核心组件加载失败")
                return
            end
        end

        local conn = humanoid.Died:Connect(function()
            if not moduleData or not moduleData.IsRespawnEnabled then return end
            local posModule = GetPositionModule()
            if not posModule then return end
            local safePos = posModule:GetAttribute("GetLastSafePos")()
            task.wait(0.15)

            humanoid.Health = humanoid.MaxHealth
            hrp.CFrame = CFrame.new(safePos + Vector3.new(0, GlobalConfig.RESPAWN_OFFSET, 0))
            humanoid:ChangeState(Enum.HumanoidStateType.Running)
            GlobalLogger.Success(module.Name, "已原地复活，传送至安全位置")
        end)

        table.insert(moduleData.RespawnConnections, conn)
    end

    local function InitModule()
        GlobalLogger.Log(module.Name, "复活绑定模块初始化中...")
        if LocalPlayer.Character then
            BindRespawnToCharacter(LocalPlayer.Character)
        end
        LocalPlayer.CharacterAdded:Connect(function(newChar)
            task.wait(GlobalConfig.CHAR_LOAD_DELAY + 0.2)
            if moduleData then
                for _, conn in ipairs(moduleData.RespawnConnections) do
                    if conn then conn:Disconnect() end
                end
                moduleData.RespawnConnections = {}
            end
            BindRespawnToCharacter(newChar)
            GlobalLogger.Debug(module.Name, "角色切换，重新绑定复活逻辑")
        end)
        GetPositionModule()
        GlobalLogger.Success(module.Name, "复活绑定模块初始化完成")
    end

    module:SetAttribute("EnableRespawn", function()
        if moduleData then
            moduleData.IsRespawnEnabled = true
        end
        GlobalLogger.Debug(module.Name, "原地复活已开启")
    end)
    module:SetAttribute("DisableRespawn", function()
        if moduleData then
            moduleData.IsRespawnEnabled = false
        end
        GlobalLogger.Debug(module.Name, "原地复活已关闭")
    end)

    InitModule()
    return module
end

-- 手机端专属UI提示系统
local MobileHintSystem = {
    ShowFullFeatureHint = function()
        local ScreenGui = Instance.new("ScreenGui")
        ScreenGui.Name = "MobileMultiModuleHint"
        ScreenGui.Parent = game:GetService("CoreGui")
        ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

        local MainFrame = Instance.new("Frame")
        MainFrame.Size = UDim2.new(0.92, 0, 0.35, 0)
        MainFrame.Position = UDim2.new(0.04, 0, 0.55, 0)
        MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
        MainFrame.BackgroundTransparency = 0.2
        MainFrame.BorderSizePixel = 0
        MainFrame.Parent = ScreenGui

        local UICorner = Instance.new("UICorner")
        UICorner.CornerRadius = UDim.new(0, 18)
        UICorner.Parent = MainFrame

        local UIGradient = Instance.new("UIGradient")
        UIGradient.Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.fromRGB(45, 45, 45)),
            ColorSequenceKeypoint.new(0.5, Color3.fromRGB(20, 20, 20)),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(45, 45, 45))
        })
        UIGradient.Rotation = 90
        UIGradient.Parent = MainFrame

        local UIStroke = Instance.new("UIStroke")
        UIStroke.Color = Color3.fromRGB(70, 70, 70)
        UIStroke.Thickness = 2
        UIStroke.Parent = MainFrame

        local TitleText = Instance.new("TextLabel")
        TitleText.Size = UDim2.new(1, 0, 0.2, 0)
        TitleText.BackgroundTransparency = 1
        TitleText.Text = "✅ 修复版多模块脚本启动成功（手机端）"
        TitleText.TextColor3 = Color3.fromRGB(0, 220, 100)
        TitleText.TextScaled = true
        TitleText.Font = Enum.Font.GothamBold
        TitleText.TextStrokeTransparency = 0.8
        TitleText.Parent = MainFrame

        local FeatureText = Instance.new("TextLabel")
        FeatureText.Size = UDim2.new(1, 0, 0.7, 0)
        FeatureText.Position = UDim2.new(0, 0, 0.25, 0)
        FeatureText.BackgroundTransparency = 1
        FeatureText.Text = "已修复nil索引问题，功能模块：\n1. " .. GlobalConfig.POSITION_MODULE_NAME .. " → 安全位置记录\n2. " .. GlobalConfig.GODMODE_MODULE_NAME .. " → 无敌+禁用死亡\n3. " .. GlobalConfig.RESPAWN_MODULE_NAME .. " → 复活+角色绑定"
        FeatureText.TextColor3 = Color3.fromRGB(255, 255, 255)
        FeatureText.TextScaled = true
        FeatureText.Font = Enum.Font.Gotham
        FeatureText.TextStrokeTransparency = 0.9
        FeatureText.Parent = MainFrame

        task.wait(7)
        for i = 1, 20 do
            MainFrame.BackgroundTransparency = MainFrame.BackgroundTransparency + 0.04
            TitleText.TextTransparency = TitleText.TextTransparency + 0.05
            FeatureText.TextTransparency = FeatureText.TextTransparency + 0.05
            UIStroke.Transparency = UIStroke.Transparency + 0.05
            task.wait(0.08)
        end
        ScreenGui:Destroy()
    end
}

-- 主程序启动入口
local function MainBootstrap()
    GlobalLogger.Log("MainBootstrap", "脚本启动中，版本：" .. GlobalConfig.VERSION)
    GlobalLogger.Log("MainBootstrap", "开始清理旧模块...")
    
    ModuleManager.CleanOldModules()
    task.wait(0.2)

    GlobalLogger.Log("MainBootstrap", "开始创建功能模块...")
    local posModule = CreateSafePositionModule()
    task.wait(0.3)
    local godModule = CreateGodModeModule()
    task.wait(0.3)
    local respawnModule = CreateAutoRespawnModule()

    local allModulesCreated = posModule and godModule and respawnModule
    if allModulesCreated then
        GlobalLogger.Success("MainBootstrap", "所有功能模块创建成功！")
    else
        GlobalLogger.Warn("MainBootstrap", "部分模块创建失败，尝试重新创建...")
        posModule = posModule or CreateSafePositionModule()
        godModule = godModule or CreateGodModeModule()
        respawnModule = respawnModule or CreateAutoRespawnModule()
    end

    MobileHintSystem:ShowFullFeatureHint()

    task.wait(1)
    GlobalLogger.Success("MainBootstrap", "脚本启动完成，已修复nil索引问题")
end

MainBootstrap()
]])()

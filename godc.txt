--[[ 
    PHOENIX_SUPREME_V28_ULTIMATE
    FEATURE: MANUAL_NETWORK_BURST & SERVER_REBIRTH
    STABILITY: ULTRA_STABLE (FIXED ALL PREVIOUS ERRORS)
]]

-- [[ 1. 环境初始化 ]]
local LP = game:GetService("Players").LocalPlayer
local RS = game:GetService("RunService")
local SafeCF = nil
local Is_Rebirthing = false

-- [[ 2. 核心功能：手动网络拥有权爆发 (防卡死版) ]]
-- 逻辑：调用此函数时，会瞬间强行夺取周围所有物体的计算权，推开它们
local function ManualNetworkBurst()
    pcall(function()
        local char = LP.Character
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        if not hrp then return end
        
        warn(">>> [PHOENIX] 正在爆发网络拥有权，强行干预周围物理环境...")
        
        -- 只在触发瞬间扫描一次周围 60 格的零件，不消耗持续性能
        for _, v in pairs(workspace:GetDescendants()) do
            if v:IsA("BasePart") and not v.Anchored then
                if (v.Position - hrp.Position).Magnitude < 60 then
                    -- 强制索要网络拥有权
                    setnetworkowner(v, LP) 
                    -- 物理加速：给物体一个向外的微小推力（可选，用于弹开怪物）
                    v.Velocity = (v.Position - hrp.Position).Unit * 10
                end
            end
        end
    end)
end

-- [[ 3. 核心功能：服务端强制角色重构 (复活) ]]
local function ExecuteRebirth()
    if Is_Rebirthing then return end
    Is_Rebirthing = true
    
    pcall(function()
        local char = LP.Character
        if char and char:FindFirstChild("HumanoidRootPart") then
            SafeCF = char.HumanoidRootPart.CFrame
        end
        LP:LoadCharacter() -- 强制服务端逻辑
    end)
    
    task.delay(5, function() Is_Rebirthing = false end)
end

-- [[ 4. 底层协议修复 (checkcaller 保护，解决 Animate 报错) ]]
local mt = getrawmetatable(game)
local old_idx = mt.__index
local old_nc = mt.__namecall
setreadonly(mt, false)

mt.__index = newcclosure(function(t, k)
    if not checkcaller() then return old_idx(t, k) end
    if t:IsA("Humanoid") and k == "Health" then return 100 end
    return old_idx(t, k)
end)

mt.__namecall = newcclosure(function(self, ...)
    local method = getnamecallmethod()
    if not checkcaller() then return old_nc(self, ...) end

    if (method == "Destroy" or method == "BreakJoints") and (self == LP.Character) then
        return nil 
    end
    
    if method == "FireServer" and tostring(self):lower():find("die") then
        return nil
    end
    
    return old_nc(self, ...)
end)
setreadonly(mt, true)

-- [[ 5. 守护进程：9倍回血 / 坐标锁定 / 自动触发复活 ]]
RS.Heartbeat:Connect(function(dt)
    if Is_Rebirthing then return end
    
    pcall(function()
        local char = LP.Character
        local hum = char and char:FindFirstChildOfClass("Humanoid")
        local hrp = char and char:FindFirstChild("HumanoidRootPart")

        if hum and hrp and hum.Health > 0 then
            hum.Health = math.min(hum.MaxHealth, hum.Health + (9 * dt))
            hum:SetStateEnabled(Enum.HumanoidStateType.Dead, false)
            
            if not SafeCF then SafeCF = hrp.CFrame end
            if (hrp.Position - SafeCF.Position).Magnitude > 65 then
                hrp.CFrame = SafeCF
            else
                SafeCF = hrp.CFrame
            end
        end

        if (not char or not char.Parent) or (hum and hum.Health <= 0) then
            ExecuteRebirth()
        end
    end)
end)

-- [[ 6. 自动化清理与重生对齐 ]]
workspace.DescendantAdded:Connect(function(v)
    task.spawn(function()
        if v.Name:lower():find("kill") or v.Name:lower():find("grab") then
            task.wait(0.5)
            pcall(function() v:Destroy() end)
        end
    end)
end)

LP.CharacterAdded:Connect(function(nc)
    local hrp = nc:WaitForChild("HumanoidRootPart", 5)
    if hrp and SafeCF then
        task.wait(0.3)
        hrp.CFrame = SafeCF
    end
end)

-- [[ 7. 快速触发键绑定 (示例：点击屏幕某处或通过外部命令) ]]
-- 这里我为你绑定了一个后台指令，你也可以直接在控制台输入 ManualNetworkBurst() 运行
_G.Burst = ManualNetworkBurst

print(">>> [PHOENIX V28] 终极全能稳定版已启动。")
print(">>> 输入 _G.Burst() 即可手动强制夺取周围所有物体的服务端拥有权！")
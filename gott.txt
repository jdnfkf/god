--[[
    UNIVERSAL SURVIVAL KERNEL V120 - "SHADOW & VISION"
    - 针对全服务端托管专项加固
    - 修复死后报错 + 爆破视角卡死
    - 适配 PROMETHEUS 混淆环境
]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Workspace = game:GetService("Workspace")

-- 跨线程持久表
shared.V120_STABLE = shared.V120_STABLE or {
    LastPos = nil,
    Power = 9,
    IsForced = true
}

-- 1. 安全沙盒：静默所有混淆产生的报错
local function Silent(f)
    return xpcall(f, function() end)
end

-- 2. 视角修复：强制解锁并重置相机
local function UnlockCamera(char)
    Silent(function()
        local cam = Workspace.CurrentCamera
        if not cam then return end
        
        -- 如果相机目标丢失，强行重置回本地玩家
        task.delay(0.1, function()
            local hum = char:FindFirstChildOfClass("Humanoid")
            if hum then
                cam.CameraType = Enum.CameraType.Custom
                cam.CameraSubject = hum
            end
        end)
    end)
end

-- 3. 网络协议欺骗
local function HookNetwork()
    local mt = getrawmetatable(game)
    local old_nc = mt.__namecall
    if setreadonly then setreadonly(mt, false) end
    
    mt.__namecall = newcclosure(function(self, ...)
        local method = getnamecallmethod()
        if (method == "FireServer" or method == "InvokeServer") then
            local n = tostring(self):lower()
            -- 拦截发往服务端的死讯信号
            if n:find("kill") or n:find("death") or n:find("damage") or n:find("died") then
                return nil
            end
        end
        return old_nc(self, ...)
    end)
    if setreadonly then setreadonly(mt, true) end
end

-- 4. 强制爆破：清除观战 UI 与 自动冷启动
local function KillSpectate()
    task.spawn(function()
        while true do
            task.wait(0.3)
            Silent(function()
                local PGui = LocalPlayer:FindFirstChild("PlayerGui")
                if PGui then
                    for _, v in pairs(PGui:GetDescendants()) do
                        if v:IsA("GuiObject") and v.Visible then
                            local name = v.Name:lower()
                            if name:find("spectate") or name:find("dead") or name:find("result") or name:find("gameover") then
                                v:Destroy()
                            end
                        end
                    end
                end
                
                -- 如果角色没了或视角卡死，强行向服务端要身体
                if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("Humanoid") then
                    LocalPlayer:LoadCharacter()
                end
            end)
        end
    end)
end

-- 5. 影子驱动 (核心生存逻辑)
local function StartKernel(char)
    if not char or not char:IsDescendantOf(Workspace) then return end
    
    -- 轮询内存，确保对象加载稳定，防止 Nil 报错
    local hum = char:WaitForChild("Humanoid", 15)
    local root = char:WaitForChild("HumanoidRootPart", 15)
    if not hum or not root then return end

    UnlockCamera(char) -- 角色加载后立即修复相机

    -- 锁定本地状态，不准角色进入死亡枚举
    hum:SetStateEnabled(Enum.HumanoidStateType.Dead, false)
    hum.BreakJointsOnDeath = false

    -- 高频回血伪装 (抵消本地死亡判定)
    local loop
    loop = RunService.Heartbeat:Connect(function()
        if not char or not char.Parent then loop:Disconnect() return end
        Silent(function()
            if hum.Health < hum.MaxHealth then
                hum.Health = hum.MaxHealth
            end
            
            -- 坐标锚点
            if hum.Health > 5 then
                shared.V120_STABLE.LastPos = root.CFrame
            end
            
            -- 位移突变修复 (防止被传送到观战区)
            if root.Position.Y < -500 or root.Velocity.Magnitude > 350 then
                if shared.V120_STABLE.LastPos then
                    root.CFrame = shared.V120_STABLE.LastPos
                end
            end
        end)
    end)
end

-- 引导启动
Silent(HookNetwork)
Silent(KillSpectate)

LocalPlayer.CharacterAdded:Connect(function(c)
    task.wait(0.5) -- 彻底解决混淆后 Nil 报错的同步延迟
    Silent(function()
        StartKernel(c)
        if shared.V120_STABLE.LastPos then
            local hrp = c:WaitForChild("HumanoidRootPart", 10)
            hrp.CFrame = shared.V120_STABLE.LastPos
        end
    end)
end)

if LocalPlayer.Character then StartKernel(LocalPlayer.Character) end
print(">>> [V120 SHADOW] 视角与报错修复已加载。")